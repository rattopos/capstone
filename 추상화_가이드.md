# 프로젝트 추상화 가이드

## 개요

프로젝트가 이제 연도, 분기, 시트에 독립적으로 동작하도록 완전히 추상화되었습니다. 하드코딩된 값들을 제거하고 동적 감지 및 설정 시스템을 구축했습니다.

## 주요 추상화 사항

### 1. 연도 및 분기 자동 감지

#### PeriodDetector 클래스 (`src/period_detector.py`)

엑셀 파일에서 사용 가능한 연도와 분기 범위를 자동으로 감지합니다.

**주요 기능:**
- `detect_available_periods(sheet_name)`: 시트에서 사용 가능한 연도/분기 범위 감지
- `get_quarter_headers(sheet_name, start_year, start_quarter, count)`: 분기 헤더 동적 생성
- `validate_period(sheet_name, year, quarter)`: 연도/분기 유효성 검증

**사용 예시:**
```python
from src.period_detector import PeriodDetector
from src.excel_extractor import ExcelExtractor

excel_extractor = ExcelExtractor('파일.xlsx')
excel_extractor.load_workbook()

detector = PeriodDetector(excel_extractor)
info = detector.detect_available_periods('소비(소매, 추가)')

print(f"기간 범위: {info['min_year']}년 ~ {info['max_year']}년")
print(f"기본값: {info['default_year']}년 {info['default_quarter']}분기")
```

### 2. 시트별 설정 시스템

#### SHEET_CONFIG 딕셔너리

각 시트의 특성을 설정으로 정의하여 유연하게 관리합니다.

**설정 항목:**
- `category_column`: 산업/업태가 있는 열 번호
- `base_year`, `base_quarter`, `base_col`: 분기 열 계산 기준점
- `name_mapping`: 산업/업태 이름 매핑
- `national_priorities`: 전국 산업/업태 우선순위
- `region_priorities`: 지역별 산업/업태 우선순위

**새 시트 추가:**
```python
SHEET_CONFIG = {
    '새시트명': {
        'category_column': 6,
        'base_year': 2023,
        'base_quarter': 1,
        'base_col': 56,
        'name_mapping': INDUSTRY_NAME_MAPPING,
        'national_priorities': None,
        'region_priorities': {},
    },
}
```

### 3. 동적 연도/분기 처리

#### TemplateFiller 개선

- `fill_template()` 함수가 연도/분기를 자동으로 감지
- 지정하지 않으면 엑셀 파일에서 최신 분기 자동 선택
- 분기 헤더를 동적으로 생성

**사용 예시:**
```python
# 자동 감지 (최신 분기 사용)
filled = template_filler.fill_template(sheet_name='소비(소매, 추가)')

# 특정 연도/분기 지정
filled = template_filler.fill_template(
    sheet_name='소비(소매, 추가)',
    year=2024,
    quarter=1
)
```

### 4. 웹 인터페이스 개선

#### API 엔드포인트

- `/api/validate`: 엑셀 파일 검증 시 시트별 연도/분기 정보도 반환
- `/api/process`: 연도/분기 자동 감지 또는 사용자 입력값 사용

**응답 형식:**
```json
{
  "valid": true,
  "sheet_names": ["시트1", "시트2", ...],
  "sheets_info": {
    "시트1": {
      "min_year": 2023,
      "max_year": 2025,
      "default_year": 2025,
      "default_quarter": 2,
      "available_periods": [(2023, 1), (2023, 2), ...]
    }
  }
}
```

#### 프론트엔드 동적 업데이트

- 엑셀 파일 업로드 시 시트별 연도/분기 범위 자동 감지
- 시트 선택 시 해당 시트의 연도/분기 옵션 자동 업데이트
- 기본값으로 최신 분기 자동 선택

## 사용 방법

### 1. CLI 사용

```bash
python src/main.py \
  --excel "파일.xlsx" \
  --template "templates/retail_sales.html" \
  --output "output.html" \
  --sheet "소비(소매, 추가)" \
  --year 2024 \
  --quarter 1
```

연도/분기를 지정하지 않으면 자동 감지됩니다.

### 2. Python 코드 사용

```python
from src.template_manager import TemplateManager
from src.excel_extractor import ExcelExtractor
from src.template_filler import TemplateFiller

# 초기화
template_manager = TemplateManager('templates/retail_sales.html')
template_manager.load_template()

excel_extractor = ExcelExtractor('파일.xlsx')
excel_extractor.load_workbook()

template_filler = TemplateFiller(template_manager, excel_extractor)

# 자동 감지
filled = template_filler.fill_template(sheet_name='소비(소매, 추가)')

# 특정 연도/분기
filled = template_filler.fill_template(
    sheet_name='소비(소매, 추가)',
    year=2024,
    quarter=1
)
```

### 3. 웹 인터페이스 사용

1. 엑셀 파일 업로드
2. 시트 선택 (자동으로 연도/분기 옵션 업데이트)
3. 연도/분기 선택 (선택하지 않으면 자동으로 최신 분기 선택)
4. 보도자료 생성

## 확장 가능성

### 새로운 시트 추가

1. 엑셀 파일에서 시트 구조 확인
2. `SHEET_CONFIG`에 시트 설정 추가
3. 필요시 이름 매핑 추가

### 새로운 연도/분기 데이터 추가

- 엑셀 파일에 새 분기 데이터를 추가하면 자동으로 감지됩니다
- 별도 설정 없이 사용 가능합니다

### 커스텀 로직 추가

- `_get_categories_for_region()` 함수를 수정하여 시트별 로직 커스터마이징
- `SHEET_CONFIG`의 `national_priorities`, `region_priorities` 활용

## 주의사항

1. **엑셀 파일 구조**: 시트별로 구조가 다를 수 있으므로 `SHEET_CONFIG`를 정확히 설정해야 합니다
2. **분기 열 계산**: `base_year`, `base_quarter`, `base_col`이 정확해야 올바른 열을 찾을 수 있습니다
3. **이름 매핑**: 엑셀의 산업/업태 이름과 템플릿에 표시할 이름이 다를 수 있으므로 매핑이 필요합니다

## 테스트

```python
# 자동 감지 테스트
python -c "
from src.excel_extractor import ExcelExtractor
from src.period_detector import PeriodDetector

e = ExcelExtractor('파일.xlsx')
e.load_workbook()
d = PeriodDetector(e)
info = d.detect_available_periods('소비(소매, 추가)')
print(f'기본값: {info[\"default_year\"]}년 {info[\"default_quarter\"]}분기')
e.close()
"
```

## 마이그레이션 가이드

기존 코드에서 하드코딩된 연도/분기를 사용하는 경우:

**이전:**
```python
filled = template_filler.fill_template(
    sheet_name='소비(소매, 추가)',
    year=2025,  # 하드코딩
    quarter=2   # 하드코딩
)
```

**이후:**
```python
# 자동 감지 (권장)
filled = template_filler.fill_template(sheet_name='소비(소매, 추가)')

# 또는 명시적으로 지정
filled = template_filler.fill_template(
    sheet_name='소비(소매, 추가)',
    year=2024,
    quarter=1
)
```

