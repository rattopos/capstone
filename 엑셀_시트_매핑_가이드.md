# 엑셀 시트별 데이터 매핑 가이드

## 문제 분석

HTML 파일이 전부 N/A로 표시되는 주요 원인:

1. **동적 마커 처리 누락**: `전국_업태1_이름`, `상위시도1_업태1_이름` 등의 업태 관련 마커가 처리되지 않음
2. **분기 열 계산 오류**: `_get_quarter_columns` 함수가 잘못된 기준점을 사용
3. **감소시도수 마커 누락**: `감소시도수` 마커가 처리되지 않음
4. **업태 이름 매핑 부재**: 소매판매 업태 이름 매핑이 없음

---

## 시트별 데이터 구조 및 매핑

### 1. 소비(소매, 추가) 시트

#### 엑셀 구조
- **Column A (1)**: 지역 코드 (00=전국, 11=서울, 21=부산, ...)
- **Column B (2)**: 지역 이름
- **Column C (3)**: 분류 단계 (0 또는 1)
- **Column E (5)**: 업태 종류 (총지수, 백화점, 대형마트, 면세점, 슈퍼마켓 및 잡화점, 편의점, 승용차 및 연료 소매점, 전문소매점, 무점포 소매)
- **Column F (6) 이후**: 연도별 데이터
- **Column 50 (R) 이후**: 분기별 데이터

#### 분기별 열 매핑
| 분기 | 열 번호 | 열 문자 | 비고 |
|------|---------|--------|------|
| 2023 3/4 | 57 | Y | |
| 2023 4/4 | 58 | Z | |
| 2024 1/4 | 59 | | |
| 2024 2/4 | 60 | | |
| 2024 3/4 | 61 | | |
| 2024 4/4 | 62 | | |
| 2025 1/4 | 63 | | |
| 2025 2/4P | 64 | | |

**계산 공식**: 
- 기준: 2023년 3분기 = Column 57
- 현재 분기 열 = 57 + (연도차이 × 4) + (분기 - 3)
- 예: 2025년 2분기 = 57 + (2 × 4) + (2 - 3) = 57 + 8 - 1 = 64 ✓

#### 데이터 행 찾기 규칙
1. **전국 총지수**: 
   - 조건: Column B = "전국" AND Column E = "총지수"
   - 위치: Row 4

2. **전국 업태별**:
   - 조건: Column A = "00" AND Column E != "총지수" AND Column C = 1
   - 위치: Row 5-12

3. **시도별 총지수**:
   - 조건: Column B = 시도명 AND Column E = "총지수"
   - 예: 서울 총지수 = Row 13

4. **시도별 업태별**:
   - 조건: Column B = 시도명 AND Column E != "총지수" AND Column C = 1
   - 해당 시도 총지수 행 다음부터 시작

#### 업태 이름 매핑
```python
RETAIL_CATEGORY_MAPPING = {
    '백화점': '백화점',
    '대형마트': '대형마트·종합소매점',
    '면세점': '면세점',
    '슈퍼마켓 및 잡화점': '슈퍼마켓·잡화점',
    '편의점': '편의점',
    '승용차 및 연료 소매점': '승용차·연료소매점',
    '전문소매점': '전문점',
    '무점포 소매': '무점포 소매'
}
```

#### 동적 마커 매핑

##### 1. 기본 마커
- `{소비(소매, 추가):기준연도}` → 현재 연도 (예: 2025)
- `{소비(소매, 추가):기준분기}` → 현재 분기 (예: 2/4)
- `{소비(소매, 추가):전국_증감률}` → 전국 총지수 증감률 계산
- `{소비(소매, 추가):서울_증감률}` → 서울 총지수 증감률 계산
- `{소비(소매, 추가):서울_2025_2분기_증감률}` → 서울 2025년 2분기 증감률

##### 2. 감소시도수 마커
- `{소비(소매, 추가):감소시도수}` → 전년동분기대비 감소한 시도 개수
- **계산 방법**: 
  - 모든 시도(전국 제외)의 총지수 증감률 계산
  - 증감률 < 0인 시도 개수 반환

##### 3. 전국 업태 마커
- `{소비(소매, 추가):전국_업태1_이름}` → 전국 상위 업태 1 이름
- `{소비(소매, 추가):전국_업태1_증감률}` → 전국 상위 업태 1 증감률
- `{소비(소매, 추가):전국_업태2_이름}` → 전국 상위 업태 2 이름
- `{소비(소매, 추가):전국_업태2_증감률}` → 전국 상위 업태 2 증감률
- `{소비(소매, 추가):전국_업태3_이름}` → 전국 상위 업태 3 이름
- `{소비(소매, 추가):전국_업태3_증감률}` → 전국 상위 업태 3 증감률

**추출 방법**:
1. Row 5-12에서 전국 업태별 데이터 추출
2. 각 업태의 증감률 계산 (현재 분기 / 전년 동분기 - 1) × 100
3. 증감률 절대값 기준으로 정렬 (감소율이 큰 순서)
4. 상위 3개 선택

##### 4. 상위/하위 시도 마커
- `{소비(소매, 추가):상위시도1_이름}` → 증감률 상위 1위 시도 이름
- `{소비(소매, 추가):상위시도1_증감률}` → 증감률 상위 1위 시도 증감률
- `{소비(소매, 추가):상위시도1_업태1_이름}` → 상위시도1의 상위 업태 1 이름
- `{소비(소매, 추가):상위시도1_업태1_증감률}` → 상위시도1의 상위 업태 1 증감률

**추출 방법**:
1. 모든 시도(전국 제외)의 총지수 증감률 계산
2. 증감률 기준 내림차순 정렬 → 상위 3개
3. 증감률 기준 오름차순 정렬 → 하위 3개
4. 각 시도의 업태별 데이터 추출 (총지수 행 다음부터)
5. 업태별 증감률 계산 후 상위 3개 선택

---

### 2. 광공업생산 시트

#### 엑셀 구조
- **Column A (1)**: 지역 코드
- **Column B (2)**: 지역 이름
- **Column C (3)**: 분류 단계
- **Column F (6)**: 산업 이름 (총지수, 반도체·전자부품, 전기장비, ...)
- **Column 50 이후**: 분기별 데이터

#### 분기별 열 매핑
- 기준: 2023년 1분기 = Column 56
- 현재 분기 열 = 56 + (연도차이 × 4) + (분기 - 1)

#### 산업 이름 매핑
기존 `INDUSTRY_NAME_MAPPING` 사용

---

### 3. 서비스업생산 시트

#### 엑셀 구조
- 광공업생산과 동일한 구조
- 산업 이름이 서비스업 관련 항목

#### 분기별 열 매핑
- 광공업생산과 동일

---

### 4. 고용 시트

#### 엑셀 구조
- 지역별 고용 데이터
- 분기별 열 매핑 확인 필요

---

### 5. 기타 시트

각 시트별로 유사한 구조를 가지지만, 세부 사항이 다를 수 있으므로 개별 확인 필요.

---

## 구현 필요 사항

### 1. template_filler.py 수정

#### `_get_quarter_columns` 함수 수정
```python
def _get_quarter_columns(self, year: int, quarter: int, sheet_name: str = None) -> tuple:
    """
    연도와 분기에 해당하는 열 번호를 반환합니다.
    
    Args:
        year: 연도
        quarter: 분기 (1-4)
        sheet_name: 시트 이름 (시트별로 기준점이 다를 수 있음)
        
    Returns:
        (현재 분기 열, 전년 동분기 열) 튜플
    """
    # 시트별 기준점 설정
    if sheet_name == '소비(소매, 추가)':
        # 2023년 3분기 = Column 57
        base_year = 2023
        base_quarter = 3
        base_col = 57
    else:
        # 기본값: 2023년 1분기 = Column 56
        base_year = 2023
        base_quarter = 1
        base_col = 56
    
    # 연도 차이 계산
    year_diff = year - base_year
    
    # 분기 오프셋 계산
    quarter_offset = (quarter - base_quarter)
    
    # 현재 분기 열 계산
    current_col = base_col + (year_diff * 4) + quarter_offset
    
    # 전년 동분기 열 계산
    prev_col = current_col - 4
    
    return (current_col, prev_col)
```

#### `_process_dynamic_marker` 함수에 업태 마커 처리 추가
```python
# 전국 업태 마커 처리
if key.startswith('전국_업태'):
    # 전국_업태1_이름, 전국_업태1_증감률 등
    industry_match = re.match(r'전국_업태(\d+)_(.+)', key)
    if industry_match:
        industry_idx = int(industry_match.group(1)) - 1
        industry_field = industry_match.group(2)
        
        # 전국 업태별 데이터 추출
        top_industries = self._get_retail_categories_for_region(
            sheet_name, '전국', year, quarter, top_n=3
        )
        
        if industry_idx < len(top_industries):
            industry = top_industries[industry_idx]
            
            if industry_field == '이름':
                return RETAIL_CATEGORY_MAPPING.get(industry['name'], industry['name'])
            elif industry_field == '증감률':
                return self.format_percentage(industry['growth_rate'], decimal_places=1)
        return "N/A"
```

#### `_get_retail_categories_for_region` 함수 추가
```python
def _get_retail_categories_for_region(self, sheet_name: str, region_name: str,
                                      year: int, quarter: int, top_n: int = 3) -> List[Dict]:
    """
    특정 지역의 업태별 증감률을 계산하여 반환 (소매판매용)
    
    Args:
        sheet_name: 시트 이름
        region_name: 지역 이름
        year: 연도
        quarter: 분기
        top_n: 상위 개수
        
    Returns:
        업태별 증감률 정보 리스트
    """
    sheet = self.excel_extractor.get_sheet(sheet_name)
    current_col, prev_col = self._get_quarter_columns(year, quarter, sheet_name)
    
    # 지역 총지수 행 찾기
    region_row = None
    for row in range(4, min(1000, sheet.max_row + 1)):
        cell_b = sheet.cell(row=row, column=2)  # 지역 이름
        cell_e = sheet.cell(row=row, column=5)  # 업태 종류
        
        if cell_b.value == region_name and cell_e.value == '총지수':
            region_row = row
            break
    
    if region_row is None:
        return []
    
    categories = []
    
    # 해당 지역의 업태별 데이터 찾기
    for row in range(region_row + 1, min(region_row + 20, sheet.max_row + 1)):
        cell_b = sheet.cell(row=row, column=2)  # 지역 이름
        cell_c = sheet.cell(row=row, column=3)  # 분류 단계
        cell_e = sheet.cell(row=row, column=5)  # 업태 종류
        
        # 같은 지역이고 분류 단계가 1인 것 (업태)
        if cell_b.value == region_name and cell_c.value == 1 and cell_e.value:
            current = sheet.cell(row=row, column=current_col).value
            prev = sheet.cell(row=row, column=prev_col).value
            
            if current is not None and prev is not None and prev != 0:
                growth_rate = ((current / prev) - 1) * 100
                categories.append({
                    'name': str(cell_e.value).strip(),
                    'growth_rate': growth_rate,
                    'row': row,
                    'current': current,
                    'prev': prev
                })
        else:
            # 다른 지역이 나오면 중단
            if cell_b.value and cell_b.value != region_name:
                break
    
    # 증감률 절대값 기준 정렬 (감소율이 큰 순서)
    categories.sort(key=lambda x: abs(x['growth_rate']), reverse=True)
    
    return categories[:top_n]
```

#### `감소시도수` 마커 처리 추가
```python
if key == '감소시도수':
    sheet = self.excel_extractor.get_sheet(sheet_name)
    current_col, prev_col = self._get_quarter_columns(year, quarter, sheet_name)
    negative_count = 0
    
    for row in range(4, min(1000, sheet.max_row + 1)):
        cell_a = sheet.cell(row=row, column=1)  # 지역 코드
        cell_b = sheet.cell(row=row, column=2)  # 지역 이름
        cell_e = sheet.cell(row=row, column=5)  # 업태 종류
        
        # 시도 총지수만 확인 (전국 제외)
        if cell_b.value and cell_e.value == '총지수':
            code_str = str(cell_a.value).strip() if cell_a.value else ''
            is_sido = (len(code_str) == 2 and code_str.isdigit() and code_str != '00')
            
            if is_sido:
                current = sheet.cell(row=row, column=current_col).value
                prev = sheet.cell(row=row, column=prev_col).value
                
                if current is not None and prev is not None and prev != 0:
                    growth_rate = ((current / prev) - 1) * 100
                    if growth_rate < 0:
                        negative_count += 1
    
    return str(negative_count)
```

#### 상위/하위 시도 업태 마커 처리 수정
기존 `상위시도1_산업1_이름` 패턴을 `상위시도1_업태1_이름` 패턴도 처리하도록 수정

---

### 2. data_analyzer.py 수정

#### 소매판매 시트용 업태 추출 함수 추가
```python
def get_retail_categories_for_region(self, sheet_name: str, region_name: str, 
                                     region_row: int, current_col: int, prev_col: int,
                                     top_n: int = 3) -> List[Dict[str, Any]]:
    """
    특정 지역의 업태별 증감률을 계산하여 반환 (소매판매용)
    """
    sheet = self.excel_extractor.get_sheet(sheet_name)
    categories = []
    
    # 해당 지역의 업태별 데이터 찾기
    for row in range(region_row + 1, min(region_row + 20, sheet.max_row + 1)):
        cell_b = sheet.cell(row=row, column=2)  # 지역 이름
        cell_c = sheet.cell(row=row, column=3)  # 분류 단계
        cell_e = sheet.cell(row=row, column=5)  # 업태 종류
        
        if cell_b.value == region_name and cell_c.value == 1 and cell_e.value:
            current = sheet.cell(row=row, column=current_col).value
            prev = sheet.cell(row=row, column=prev_col).value
            
            if current is not None and prev is not None and prev != 0:
                growth_rate = ((current / prev) - 1) * 100
                categories.append({
                    'name': str(cell_e.value).strip(),
                    'growth_rate': growth_rate,
                    'row': row,
                    'current': current,
                    'prev': prev
                })
        else:
            if cell_b.value and cell_b.value != region_name:
                break
    
    # 증감률 절대값 기준 정렬
    categories.sort(key=lambda x: abs(x['growth_rate']), reverse=True)
    
    return categories[:top_n]
```

---

## 테스트 체크리스트

- [ ] 전국 총지수 증감률 계산
- [ ] 시도별 총지수 증감률 계산
- [ ] 전국 업태별 증감률 계산 및 상위 3개 추출
- [ ] 상위/하위 시도 추출
- [ ] 상위/하위 시도 업태별 증감률 계산
- [ ] 감소시도수 계산
- [ ] 분기별 증감률 테이블 채우기
- [ ] 업태 이름 매핑 적용

---

## 참고사항

1. **엑셀 파일 구조 변경 시**: 각 시트의 분기별 열 위치가 다를 수 있으므로 시트별로 기준점을 설정해야 함
2. **업태 이름 변경 시**: `RETAIL_CATEGORY_MAPPING` 딕셔너리를 업데이트
3. **데이터 누락 처리**: 셀 값이 None이거나 0인 경우 적절히 처리 (N/A 반환 또는 스킵)

