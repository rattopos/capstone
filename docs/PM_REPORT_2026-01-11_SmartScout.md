# 📊 PM 보고서: 엑셀 구조 변경 대응 시스템 구축

**보고일자**: 2026-01-11  
**보고자**: 개발팀  
**프로젝트**: 지역경제동향 보도자료 생성기  
**작업명**: Smart Scout - 유연한 엑셀 탐색 시스템 구현

---

## 📋 Executive Summary

엑셀 파일의 시트명이나 컬럼 위치가 변경될 때마다 코드를 수정해야 하는 문제를 해결하기 위해, **"특징 기반 탐색 시스템"**을 구축했습니다. 이제 시스템은 하드코딩된 위치가 아닌 **키워드와 앵커 포인트**를 기반으로 데이터를 찾아 구조 변경에 유연하게 대응할 수 있습니다.

### 핵심 성과
- ✅ **시트명 변경 대응**: "광공업생산" → "2025_광공업_최종"으로 변경되어도 자동 인식
- ✅ **컬럼 위치 변경 대응**: 컬럼이 한 칸 밀려도 앵커 포인트로 정확한 위치 파악
- ✅ **설정 외재화**: 코드 수정 없이 JSON 파일만 수정하여 매핑 규칙 변경 가능
- ✅ **Fail-Safe 메커니즘**: 구조 변경 시에도 시스템이 뻗지 않고 해당 섹션만 N/A 처리

---

## 🎯 배경 및 문제점

### 기존 문제
1. **하드코딩된 시트명**: 코드에 `sheet_name='광공업생산'`처럼 정확한 시트명이 박혀있어 변경 시 코드 수정 필요
2. **하드코딩된 컬럼 인덱스**: `curr_col: 64, prev_col: 60`처럼 고정된 컬럼 번호 사용
3. **재배포 필요**: 엑셀 구조가 조금만 바뀌어도 코드 수정 → 빌드 → 배포 과정 필요
4. **시스템 불안정**: 구조 변경 시 전체 프로세스가 중단되어 사용자 경험 저하

### 비즈니스 임팩트
- **유지보수 비용 증가**: 엑셀 구조 변경 시마다 개발자 개입 필요
- **다운타임 발생**: 구조 변경 시 시스템이 작동하지 않아 서비스 중단
- **확장성 제한**: 새로운 시트나 컬럼 추가 시 코드 전면 수정 필요

---

## 💡 해결 방안

### 핵심 철학
> **"엑셀의 위치를 외우지 말고, '특징'을 찾으십시오."**

시트명이나 컬럼 번호가 아닌 **의미 있는 키워드와 패턴**을 기반으로 데이터를 찾는 방식으로 전환했습니다.

### 구현 전략 (4단계)

#### Step 1: 앵커 포인트 기반 컬럼 매핑
- **목적**: 하드코딩된 컬럼 인덱스 제거
- **방법**: 상위 10행을 스캔하여 "2024.1/4", "전년동기비", "증감률" 같은 핵심 키워드 위치 탐지
- **효과**: 컬럼이 밀려도 키워드 위치만 찾으면 정확한 데이터 추출 가능

#### Step 2: 동적 설정 파일 도입
- **목적**: 코드 수정 없이 매핑 규칙 변경 가능
- **방법**: `config/excel_mapping.json` 파일에 키워드, 앵커 포인트, 총지수 값 등 정의
- **효과**: 엑셀 구조 변경 시 JSON 파일만 수정하면 즉시 반영 (재배포 불필요)

#### Step 3: 방어적 검증 시스템
- **목적**: 구조 변경 시 시스템이 뻗지 않도록 보호
- **방법**: 데이터 추출 전 구조 검증, 실패 시 해당 섹션만 N/A 처리
- **효과**: 전체 프로세스 중단 없이 부분 실패 처리 가능 (Fail-Safe)

#### Step 4: Two-pass Reading 최적화
- **목적**: 성능 최적화 및 불필요한 데이터 로드 방지
- **방법**: 헤더 영역만 먼저 읽어 구조 파악 후 필요한 범위만 재읽기
- **효과**: 메모리 사용량 감소 및 처리 속도 향상

---

## 🔧 기술적 구현 상세

### 주요 변경 사항

#### 1. `extractors/base.py` - 핵심 탐색 엔진
```python
# 신규 기능
- find_anchor_points(): 앵커 포인트 탐지
- find_column_by_anchor(): 앵커 기반 컬럼 찾기
- _load_sheet_header(): Two-pass reading (헤더 우선 읽기)
- validate_structure(): 구조 검증
- safe_extract_with_validation(): 안전한 데이터 추출
```

#### 2. `config/excel_mapping.json` - 설정 외재화
```json
{
  "manufacturing": {
    "keywords": ["광공업", "생산"],
    "header_anchors": ["지수", "증감률", "전년동기비"],
    "total_code_values": ["BCD", "0", "총지수", "계"]
  },
  ...
}
```

#### 3. `services/summary_data.py` - 통합
- 앵커 기반 컬럼 찾기 함수 추가
- 기존 동적 계산 방식과 통합 (Fallback 메커니즘)
- `get_summary_table_data()`에서 앵커 기반 우선 사용

### 호환성 보장
- **기존 코드와 완벽 호환**: 앵커 기반 탐색 실패 시 기존 동적 계산 방식으로 자동 전환
- **점진적 마이그레이션**: 기존 코드는 그대로 두고 새 기능 추가
- **Zero Downtime**: 배포 중에도 서비스 중단 없음

---

## 📈 기대 효과

### 단기 효과
1. **유지보수 비용 절감**: 엑셀 구조 변경 시 코드 수정 불필요 → JSON 파일만 수정
2. **다운타임 제거**: 구조 변경 시에도 시스템 정상 작동
3. **사용자 경험 개선**: 구조 변경 시에도 데이터 추출 가능 (일부 N/A 처리)

### 장기 효과
1. **확장성 향상**: 새로운 시트나 컬럼 추가 시 설정 파일만 수정
2. **안정성 향상**: Fail-Safe 메커니즘으로 부분 실패에도 시스템 운영 가능
3. **개발 생산성 향상**: 반복적인 코드 수정 작업 감소

---

## 🧪 테스트 결과

### 검증 항목
- ✅ 앵커 기반 컬럼 찾기: 정상 동작 (분기 패턴 인식 성공)
- ✅ Fallback 메커니즘: 앵커 찾기 실패 시 기존 동적 계산으로 정상 전환
- ✅ 설정 파일 로드: 정상 동작
- ✅ 방어적 검증: 구조 변경 시 경고 출력, 프로세스 중단 없음

### 시나리오 테스트
1. **시트명 변경**: "광공업생산" → "2025_광공업_최종" → ✅ 키워드("광공업", "생산")로 자동 인식
2. **컬럼 위치 변경**: 컬럼이 한 칸 밀림 → ✅ 앵커 포인트("2024.1/4")로 정확한 위치 파악
3. **구조 변경**: 필수 앵커 누락 → ✅ 해당 섹션만 N/A 처리, 전체 프로세스 정상 작동

---

## 📝 향후 계획

### Phase 2 (예정)
1. **자동 학습 기능**: 엑셀 구조 변경 패턴 학습하여 자동 대응
2. **시각적 검증 도구**: 설정 파일 수정을 위한 UI 제공
3. **모니터링 강화**: 구조 변경 감지 및 알림 시스템

### 장기 로드맵
1. **AI 기반 구조 분석**: 완전 자동화된 엑셀 구조 인식
2. **멀티 버전 지원**: 여러 버전의 엑셀 파일 동시 지원
3. **실시간 구조 추적**: 엑셀 파일 업로드 시 자동으로 구조 분석 및 매핑

---

## 💼 비즈니스 권고사항

### 즉시 적용 가능
- ✅ **설정 파일 기반 관리**: 엑셀 구조 변경 시 개발팀에 문의하지 않고 설정 파일만 수정
- ✅ **Fail-Safe 운영**: 구조 변경으로 인한 서비스 중단 걱정 없이 운영 가능

### 주의사항
- ⚠️ **설정 파일 백업**: `config/excel_mapping.json` 파일은 버전 관리 필수
- ⚠️ **정기 점검**: 엑셀 구조 변경 시 설정 파일도 함께 업데이트 필요

---

## 📎 참고 자료

- **기술 문서**: `docs/DEBUG_LOG.md` (2026-01-11 저녁 항목)
- **설정 파일**: `config/excel_mapping.json`
- **주요 코드**: 
  - `extractors/base.py` (핵심 탐색 엔진)
  - `services/summary_data.py` (통합 로직)

---

**보고 완료일**: 2026-01-11  
**다음 리뷰 예정일**: 2026-01-18 (1주일 후)
