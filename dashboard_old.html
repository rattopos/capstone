<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì§€ì—­ê²½ì œë™í–¥ ë³´ë„ìë£Œ ìƒì„± ì‹œìŠ¤í…œ - êµ­ê°€ë°ì´í„°ì²˜</title>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a25;
            --bg-card: #1e1e2a;
            --bg-card-hover: #252535;
            --accent-primary: #6366f1;
            --accent-secondary: #818cf8;
            --accent-glow: rgba(99, 102, 241, 0.3);
            --success: #22c55e;
            --success-glow: rgba(34, 197, 94, 0.3);
            --warning: #f59e0b;
            --warning-glow: rgba(245, 158, 11, 0.3);
            --danger: #ef4444;
            --danger-glow: rgba(239, 68, 68, 0.3);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border: #2e2e3e;
            --border-hover: #3e3e50;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow: auto;
        }

        /* Animated background */
        .bg-pattern {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, var(--accent-glow) 0%, transparent 40%),
                radial-gradient(circle at 80% 20%, rgba(139, 92, 246, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 50% 50%, rgba(6, 182, 212, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        /* Header */
        .header {
            position: relative;
            z-index: 10;
            background: linear-gradient(180deg, var(--bg-secondary) 0%, transparent 100%);
            border-bottom: 1px solid var(--border);
            padding: 0.75rem 1.5rem;
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 2rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent-primary) 0%, #8b5cf6 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            box-shadow: 0 4px 20px var(--accent-glow);
        }

        .logo-text h1 {
            font-size: 1rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--accent-secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .logo-text p {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .select-group {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            background: var(--bg-tertiary);
            padding: 0.4rem 0.75rem;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .select-group label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .select-group select {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.3rem 0.5rem;
            border-radius: 5px;
            font-family: inherit;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .select-group select:hover {
            border-color: var(--accent-primary);
        }

        .select-group select:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        /* Period Display (ìë™ê°ì§€) */
        .period-display {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: linear-gradient(135deg, var(--bg-tertiary), var(--bg-card));
            padding: 0.4rem 0.75rem;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .period-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .period-value {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--accent-primary);
            padding: 0.2rem 0.5rem;
            background: var(--accent-glow);
            border-radius: 6px;
        }

        .period-value.waiting {
            color: var(--text-secondary);
            background: transparent;
            font-weight: 400;
        }

        /* Main Layout */
        .main-container {
            position: relative;
            z-index: 10;
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            min-height: calc(100vh - 60px);
        }

        /* Sidebar - ì œê±°ë¨ (ì¸ë¼ì¸ìœ¼ë¡œ í†µí•©) */
        .sidebar {
            display: contents; /* ê·¸ë¦¬ë“œ/í”Œë ‰ìŠ¤ ì»¨í…ìŠ¤íŠ¸ì—ì„œ ì œê±° */
        }

        .upload-section {
            width: 100%;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
            transition: all 0.3s;
            min-height: 200px;
            display: block !important;
            visibility: visible !important;
        }

        .upload-section:hover {
            border-color: var(--border-hover);
            background: var(--bg-card-hover);
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .upload-zone {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: var(--bg-tertiary);
            min-height: 180px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .upload-zone:hover {
            border-color: var(--accent-primary);
            background: rgba(99, 102, 241, 0.05);
        }

        .upload-zone.dragover {
            border-color: var(--accent-primary);
            background: rgba(99, 102, 241, 0.1);
            transform: scale(1.02);
        }

        .upload-zone.uploaded {
            border-color: var(--success);
            background: rgba(34, 197, 94, 0.05);
        }

        .upload-icon {
            font-size: 3.5rem;
            margin-bottom: 1rem;
            opacity: 0.9;
        }

        .upload-text {
            color: var(--text-primary);
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 0.75rem;
        }

        .upload-hint {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .upload-filename {
            color: var(--success);
            font-size: 0.75rem;
            font-weight: 500;
            margin-top: 0.25rem;
            word-break: break-all;
        }

        /* Report List */
        .report-list-section {
            width: 100%;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            min-height: 400px;
        }

        /* Tab Buttons */
        .tab-buttons {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 0.5rem;
        }

        .tab-btn {
            flex: 1;
            padding: 0.4rem 0.5rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            background: var(--bg-card-hover);
            border-color: var(--border-hover);
        }

        .tab-btn.active {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2) 0%, rgba(139, 92, 246, 0.1) 100%);
            border-color: var(--accent-primary);
            color: var(--text-primary);
        }

        .report-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 1rem;
        }

        .report-item {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
            min-height: 100px;
        }

        .report-item:hover {
            background: var(--bg-card-hover);
            border-color: var(--border-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .report-item.active {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2) 0%, rgba(139, 92, 246, 0.1) 100%);
            border-color: var(--accent-primary);
        }

        .report-item.reviewed {
            background: rgba(34, 197, 94, 0.1);
            border-color: var(--success);
        }

        .report-item.has-missing {
            background: rgba(245, 158, 11, 0.1);
            border-color: var(--warning);
        }

        .report-item.generated {
            background: rgba(99, 102, 241, 0.1);
            border-color: var(--accent-secondary);
        }

        .report-item-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            width: 100%;
        }

        .report-icon {
            width: 40px;
            height: 40px;
            background: var(--bg-card);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .report-info {
            flex: 1;
            min-width: 0;
        }

        .report-name {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: var(--text-primary);
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .report-sheet {
            font-size: 0.65rem;
            color: var(--text-muted);
            display: none;
        }

        .report-status {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            flex-shrink: 0;
        }

        .report-status.pending {
            color: var(--text-muted);
        }

        .report-status.generated {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
        }

        .report-status.reviewed {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        .report-status.edited {
            background: #f59e0b;
            border-color: #f59e0b;
            color: white;
        }

        .report-item.edited {
            border-left: 3px solid #f59e0b;
        }

        .report-status.has-missing {
            background: var(--warning);
            border-color: var(--warning);
            color: white;
        }

        /* Main Content */
        .main-content {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 20px;
        }

        /* Control Bar - ë¯¸ë¦¬ë³´ê¸° í—¤ë”ì— í†µí•©ë¨ */
        .control-bar {
            display: none; /* ë¯¸ë¦¬ë³´ê¸° í—¤ë”ì— í†µí•©ë˜ì–´ ìˆ¨ê¹€ */
        }

        /* ë¯¸ë¦¬ë³´ê¸° í—¤ë” ë‚´ ë„¤ë¹„ê²Œì´ì…˜ ì»¨íŠ¸ë¡¤ */
        .preview-header .nav-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-left: 1rem;
            padding-left: 1rem;
            border-left: 1px solid var(--border);
        }

        .preview-header .action-btns {
            display: flex;
            gap: 0.5rem;
        }

        .nav-controls {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .nav-btn {
            width: 32px;
            height: 32px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-btn:hover:not(:disabled) {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        .nav-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .page-indicator {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .action-btns {
            display: flex;
            gap: 0.75rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-primary) 0%, #8b5cf6 100%);
            border: none;
            color: white;
            box-shadow: 0 4px 15px var(--accent-glow);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px var(--accent-glow);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-primary);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--bg-card-hover);
            border-color: var(--border-hover);
        }

        .btn-success {
            background: var(--success);
            border: none;
            color: white;
            box-shadow: 0 4px 15px var(--success-glow);
        }

        .btn-edit {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
        }

        .btn-edit:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
        }

        .btn-save {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
        }

        .btn-save:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .btn-cancel {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
        }

        .btn-cancel:hover:not(:disabled) {
            background: var(--bg-card-hover);
            color: var(--error);
        }

        .btn-success:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px var(--success-glow);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Preview Area */
        .preview-area {
            flex: 1;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .preview-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 1rem;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
            gap: 1rem;
        }

        .preview-header-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex: 1;
        }

        .preview-header-right {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .preview-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .preview-content {
            background: white;
            flex: 1;
            overflow: hidden;
            min-height: 0;
        }

        .preview-iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
            overflow: auto;
        }

        .preview-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-muted);
            background: var(--bg-tertiary);
        }

        .preview-placeholder-icon {
            font-size: 2.5rem;
            margin-bottom: 0.75rem;
            opacity: 0.5;
        }

        .preview-placeholder h3 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .preview-placeholder p {
            font-size: 0.8rem;
            max-width: 350px;
            text-align: center;
            line-height: 1.5;
        }

        /* Preview Actions */
        .preview-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Edit Mode Styles */
        .edit-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            background: #f8f9fa;
        }

        .edit-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-bottom: 2px solid #f59e0b;
        }

        .edit-mode-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            color: #92400e;
            font-size: 0.9rem;
        }

        .edit-hint {
            font-size: 0.8rem;
            color: #b45309;
        }

        .edit-content {
            flex: 1;
            overflow: auto;
            padding: 1rem;
            background: white;
        }

        .edit-content [contenteditable="true"] {
            outline: none;
            min-height: 1em;
            transition: background-color 0.2s;
        }

        .edit-content [contenteditable="true"]:hover {
            background-color: rgba(245, 158, 11, 0.1);
        }

        .edit-content [contenteditable="true"]:focus {
            background-color: rgba(245, 158, 11, 0.2);
            box-shadow: inset 0 0 0 2px #f59e0b;
        }

        /* í¸ì§‘ ë¶ˆê°€ ìš”ì†Œ í‘œì‹œ */
        .edit-content .no-edit {
            pointer-events: none;
            opacity: 0.7;
        }

        .edit-content img,
        .edit-content svg,
        .edit-content canvas {
            pointer-events: none;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: all 0.3s;
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .modal-close {
            width: 36px;
            height: 36px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: var(--danger);
            border-color: var(--danger);
        }

        .missing-field-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .missing-field-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1rem;
        }

        .missing-field-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .missing-field-input {
            width: 100%;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.75rem 1rem;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .missing-field-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
        }

        /* Progress */
        .progress-bar {
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 1rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary) 0%, #8b5cf6 100%);
            border-radius: 2px;
            transition: width 0.5s ease;
        }

        /* Toast */
        .toast-container {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 1001;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .toast {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            min-width: 300px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease;
        }

        .toast.success {
            border-color: var(--success);
        }

        .toast.error {
            border-color: var(--danger);
        }

        .toast.warning {
            border-color: var(--warning);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Upload Modal */
        .upload-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 10, 15, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1003;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .upload-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .upload-modal-content {
            width: 90%;
            max-width: 450px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
        }

        .upload-modal-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            animation: bounce 1s ease infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .upload-modal-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .upload-modal-subtitle {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
        }

        .upload-steps {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .upload-step {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: var(--bg-tertiary);
            border-radius: 10px;
            border: 1px solid var(--border);
            transition: all 0.3s;
        }

        .upload-step.active {
            border-color: var(--accent-primary);
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), transparent);
        }

        .upload-step.completed {
            border-color: var(--success);
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), transparent);
        }

        .upload-step.skipped {
            opacity: 0.5;
        }

        .upload-step .step-icon {
            font-size: 1.2rem;
            width: 28px;
            text-align: center;
        }

        .upload-step .step-text {
            flex: 1;
            text-align: left;
            font-size: 0.85rem;
            color: var(--text-primary);
        }

        .upload-step .step-status {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .upload-progress-bar {
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 1.5rem;
        }

        .upload-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            width: 0%;
            transition: width 0.3s;
        }

        .upload-result {
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 12px;
            border: 1px solid var(--success);
        }

        .upload-result .result-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
        }

        .upload-result .result-item:not(:last-child) {
            border-bottom: 1px solid var(--border);
        }

        .upload-result .result-label {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .upload-result .result-value {
            color: var(--accent-primary);
            font-weight: 600;
            font-size: 0.9rem;
        }

        /* Loading - í° ì§„í–‰ë¥  í‘œì‹œ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 10, 15, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1002;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .loading-content {
            width: 90%;
            max-width: 600px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 2.5rem;
            text-align: center;
        }

        .loading-icon {
            font-size: 4rem;
            margin-bottom: 1.5rem;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        .loading-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--accent-secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .loading-subtitle {
            color: var(--text-secondary);
            font-size: 0.95rem;
            margin-bottom: 2rem;
        }

        .loading-progress-container {
            margin-bottom: 1.5rem;
        }

        .loading-progress-bar {
            height: 12px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .loading-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary) 0%, #8b5cf6 50%, var(--success) 100%);
            border-radius: 6px;
            transition: width 0.3s ease;
            box-shadow: 0 0 20px var(--accent-glow);
        }

        .loading-stats {
            display: flex;
            justify-content: space-between;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .loading-current-item {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 10px;
            margin-bottom: 1.5rem;
        }

        .loading-current-icon {
            font-size: 1.5rem;
        }

        .loading-current-text {
            color: var(--text-primary);
            font-weight: 500;
        }

        .loading-time-container {
            display: flex;
            justify-content: center;
            gap: 2rem;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .loading-time-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
        }

        .loading-time-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-secondary);
            font-variant-numeric: tabular-nums;
        }

        .loading-time-label {
            font-size: 0.75rem;
        }

        /* ìƒì„± ì™„ë£Œ ìƒíƒœ - ë” ì»´íŒ©íŠ¸í•˜ê²Œ */
        .generation-status {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.5rem 1rem;
            margin-bottom: 0.5rem;
            display: none;
        }

        .generation-status.active {
            display: block;
        }

        .generation-status-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.25rem;
        }

        .generation-status-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            color: var(--success);
        }

        .generation-status-count {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .generation-mini-progress {
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            overflow: hidden;
        }

        .generation-mini-fill {
            height: 100%;
            background: var(--success);
            border-radius: 2px;
        }

        /* ì ‘ê·¼ì„± ê°œì„  */
        .upload-zone:focus {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
        }

        .btn:focus-visible {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
        }

        /* í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜ ê°œì„  */
        .report-item:focus {
            outline: 2px solid var(--accent-primary);
            outline-offset: -2px;
        }

        /* ë¡œë”© ìƒíƒœ ê°œì„  */
        .upload-zone.processing {
            border-color: var(--accent-primary);
            background: rgba(99, 102, 241, 0.1);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .main-container {
                max-width: 100%;
                padding: 30px 15px;
            }

            .header-content {
                flex-wrap: wrap;
            }

            .report-list {
                grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            }
        }

        @media (max-width: 900px) {
            .main-container {
                padding: 20px 15px;
                gap: 15px;
            }

            .upload-section {
                padding: 1.5rem;
            }

            .upload-zone {
                padding: 2rem 1.5rem;
                min-height: 150px;
            }

            .upload-icon {
                font-size: 2.5rem;
            }

            .upload-text {
                font-size: 1rem;
            }

            .report-list {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 12px;
            }

            .header-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .header-controls {
                width: 100%;
                flex-wrap: wrap;
            }

            .logo-text h1 {
                font-size: 0.9rem;
            }

            .logo-text p {
                font-size: 0.65rem;
            }
        }

        @media (max-width: 600px) {
            .main-container {
                padding: 0.5rem;
            }

            .upload-zone {
                padding: 0.75rem;
            }

            .upload-text {
                font-size: 0.75rem;
            }

            .control-bar {
                flex-direction: column;
                gap: 0.5rem;
            }

            .action-btns {
                width: 100%;
            }

            .btn {
                flex: 1;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="bg-pattern"></div>

    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">ğŸ“Š</div>
                <div class="logo-text">
                    <h1>ì§€ì—­ê²½ì œë™í–¥ ë³´ë„ìë£Œ ìƒì„± ì‹œìŠ¤í…œ</h1>
                    <p>êµ­ê°€ë°ì´í„°ì²˜ Â· Ministry of Data and Statistics</p>
                </div>
            </div>
            <div class="header-controls">
                <div class="period-display" id="periodDisplay" title="ë¶„ì„í‘œì—ì„œ ìë™ìœ¼ë¡œ ì¶”ì¶œëœ ì—°ë„/ë¶„ê¸° ì •ë³´">
                    <span class="period-label">ğŸ“… ê¸°ì¤€ì‹œì </span>
                    <span class="period-value waiting" id="periodValue">íŒŒì¼ ì—…ë¡œë“œ ëŒ€ê¸°ì¤‘...</span>
                    <input type="hidden" id="yearSelect" value="2025">
                    <input type="hidden" id="quarterSelect" value="2">
                </div>
                <button class="btn btn-secondary" id="contactInfoBtn" onclick="openContactModal()" title="ë‹´ë‹¹ë¶€ì„œ/ë‹´ë‹¹ì ì„¤ì •">
                    âš™ï¸ ë‹´ë‹¹ì ì„¤ì •
                </button>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container">
            <!-- Upload Section -->
            <div class="upload-section">
                <div class="section-title">ğŸ“ ë¶„ì„í‘œ ì—…ë¡œë“œ</div>
                <div class="upload-zone" id="uploadZone" role="button" aria-label="ë¶„ì„í‘œ íŒŒì¼ ì—…ë¡œë“œ" tabindex="0">
                    <div class="upload-icon">ğŸ“„</div>
                    <p class="upload-text">ë¶„ì„í‘œ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì„¸ìš”</p>
                    <p class="upload-hint" style="line-height: 1.4; margin-top: 0.5rem;">
                        <span style="color: var(--success); font-weight: 600;">âœ“ ë¶„ì„í‘œ(.xlsx)</span> íŒŒì¼ë§Œ ì—…ë¡œë“œí•˜ì„¸ìš”<br>
                        <span style="color: var(--text-muted); font-size: 0.7rem;">ì—…ë¡œë“œ í›„ ìë™ìœ¼ë¡œ ë³´ë„ìë£Œê°€ ìƒì„±ë©ë‹ˆë‹¤</span>
                    </p>
                    <p class="upload-filename" id="uploadFilename" style="display: none;"></p>
                </div>
                <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
                <div class="progress-bar" id="progressBar" style="display: none;">
                    <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
                </div>
                
                <!-- Conversion Info (ì‚¬ìš©í•˜ì§€ ì•ŠìŒ - ë¶„ì„í‘œë§Œ ì—…ë¡œë“œ) -->
                <div class="conversion-info" id="conversionInfo" style="display: none;"></div>
                    
                    <!-- ë¶„ì„í‘œ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ì œê±° (ë¶„ì„í‘œë§Œ ì—…ë¡œë“œ) -->
                    
                    <!-- ë³´ë„ìë£Œ ìƒì„± ì•ˆë‚´ (ë¶„ì„í‘œ ì—…ë¡œë“œ ì‹œì—ë§Œ í‘œì‹œ) -->
                    <div id="reportGenerationHint" style="display: none; margin-top: 0.75rem; padding: 0.75rem; background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(16, 185, 129, 0.05)); border-radius: 8px; border-left: 3px solid var(--success);">
                        <div style="font-size: 0.75rem; color: var(--text-primary); line-height: 1.6;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <span style="font-size: 1.2rem;">âœ…</span>
                                <strong style="color: var(--success); font-size: 0.8rem;">ë³´ë„ìë£Œ ìƒì„± ì¤€ë¹„ ì™„ë£Œ</strong>
                            </div>
                            <div style="padding-left: 1.7rem; color: var(--text-secondary);">
                                â€¢ ìš°ì¸¡ ë¯¸ë¦¬ë³´ê¸°ì—ì„œ ë³´ë„ìë£Œ í™•ì¸<br>
                                â€¢ í•„ìš”ì‹œ ì§ì ‘ í¸ì§‘ ê°€ëŠ¥<br>
                                â€¢ ë‚´ë³´ë‚´ê¸°ë¡œ í•œê¸€ íŒŒì¼ ìƒì„±
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Report List -->
            <div class="report-list-section">
                <div class="section-title">ğŸ“‹ ë³´ë„ìë£Œ ëª©ë¡ <span id="reportCountBadge" style="font-size: 0.75rem; color: var(--text-secondary);"></span></div>
                
                <!-- ì „ì²´ ë³´ë„ìë£Œ í†µí•© ë¦¬ìŠ¤íŠ¸ (ìˆœì°¨ì  í˜ì´ì§€ ë„˜ê¹€) -->
                <div class="report-list" id="allReportsList">
                    <!-- ì´ˆê¸° ìƒíƒœ ì•ˆë‚´ -->
                    <div style="padding: 1.5rem; text-align: center; color: var(--text-secondary);">
                        <div style="font-size: 2rem; margin-bottom: 0.75rem;">ğŸ“‹</div>
                        <div style="font-size: 0.85rem; font-weight: 600; margin-bottom: 0.75rem;">ë³´ë„ìë£Œ ëª©ë¡</div>
                        <div style="font-size: 0.75rem; line-height: 1.6; color: var(--text-muted); text-align: left; padding: 0 0.5rem;">
                            <div style="margin-bottom: 0.5rem;">ğŸ“Œ <strong>ì‚¬ìš© ë°©ë²•</strong></div>
                            <div style="padding-left: 1rem; margin-bottom: 0.75rem;">
                                1. ì™¼ìª½ì—ì„œ <strong style="color: var(--success);">ë¶„ì„í‘œ</strong> ì—…ë¡œë“œ<br>
                                2. ìë™ìœ¼ë¡œ ë³´ë„ìë£Œ ìƒì„±<br>
                                3. ìš°ì¸¡ì—ì„œ ë¯¸ë¦¬ë³´ê¸° í™•ì¸<br>
                                4. í¸ì§‘ í›„ ë‚´ë³´ë‚´ê¸°
                            </div>
                            <div style="border-top: 1px solid var(--border); padding-top: 0.75rem; margin-top: 0.75rem;">
                                <div style="font-size: 0.7rem; color: var(--text-muted);">
                                    ğŸ’¡ <strong>ë³´ë„ìë£Œ ì¢…ë¥˜</strong><br>
                                    â€¢ ìš”ì•½ ë³´ë„ìë£Œ (6ê°œ)<br>
                                    â€¢ ë¶€ë¬¸ë³„ ë³´ë„ìë£Œ (9ê°œ)<br>
                                    â€¢ ì‹œë„ë³„ ë³´ë„ìë£Œ (17ê°œ)<br>
                                    â€¢ í†µê³„í‘œ (10ê°œ)
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Generation Status -->
            <div class="generation-status" id="generationStatus">
                <div class="generation-status-header">
                    <span class="generation-status-title">
                        <span>âœ…</span>
                        <span>ë¯¸ë¦¬ë³´ê¸° ìƒì„± ì™„ë£Œ</span>
                    </span>
                    <span class="generation-status-count" id="generationStatusCount">50/50</span>
                </div>
                <div class="generation-mini-progress">
                    <div class="generation-mini-fill" id="generationMiniFill" style="width: 100%;"></div>
                </div>
            </div>

            <!-- Preview Area -->
            <div class="preview-area">
                <div class="preview-header">
                    <div class="preview-header-left">
                        <div class="preview-title" id="previewTitle">
                            <span>ğŸ“„</span>
                            <span>ë¯¸ë¦¬ë³´ê¸°</span>
                        </div>
                        <div class="nav-controls">
                            <button class="nav-btn" id="prevBtn" disabled title="ì´ì „">â—€</button>
                            <span class="page-indicator" id="pageIndicator">0 / 0</span>
                            <button class="nav-btn" id="nextBtn" disabled title="ë‹¤ìŒ">â–¶</button>
                        </div>
                    </div>
                    <div class="preview-header-right">
                        <div class="action-btns">
                            <button class="btn btn-hwp-import" id="exportHwpReadyBtn" style="display: none; background: linear-gradient(135deg, #9c27b0, #7b1fa2); border-color: #6a1b9a; color: white;" title="ëª¨ë“  ë³´ë„ìë£Œë¥¼ í•œê¸€ íŒŒì¼ìš© HTMLë¡œ ë‚´ë³´ë‚´ê¸°">
                                ğŸ“„ ë‚´ë³´ë‚´ê¸°
                            </button>
                        </div>
                        <div class="preview-actions">
                        <button class="btn btn-edit" id="editBtn" style="display: none;" title="í¸ì§‘ ëª¨ë“œ">
                            âœï¸ í¸ì§‘
                        </button>
                        <button class="btn btn-save" id="saveEditBtn" style="display: none;" title="ë³€ê²½ì‚¬í•­ ì €ì¥">
                            ğŸ’¾ ì €ì¥
                        </button>
                        <button class="btn btn-cancel" id="cancelEditBtn" style="display: none;" title="í¸ì§‘ ì·¨ì†Œ">
                            âœ• ì·¨ì†Œ
                        </button>
                        <button class="btn btn-secondary" id="markReviewedBtn" style="display: none;">
                            âœ“ ê²€í†  ì™„ë£Œ
                        </button>
                        </div>
                    </div>
                </div>
                <div class="preview-content" id="previewContent">
                    <div class="preview-placeholder" id="previewPlaceholder">
                        <div class="preview-placeholder-icon">ğŸ“Š</div>
                        <h3>ë³´ë„ìë£Œ ë¯¸ë¦¬ë³´ê¸°</h3>
                        <p style="line-height: 1.6; margin-top: 1rem;">
                            <strong>1ë‹¨ê³„:</strong> ì™¼ìª½ì—ì„œ ë¶„ì„í‘œ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”<br>
                            <strong>2ë‹¨ê³„:</strong> ìë™ìœ¼ë¡œ ìƒì„±ëœ ë³´ë„ìë£Œ ëª©ë¡ì„ í™•ì¸í•˜ì„¸ìš”<br>
                            <strong>3ë‹¨ê³„:</strong> ë³´ë„ìë£Œë¥¼ ì„ íƒí•˜ì—¬ ë¯¸ë¦¬ë³´ê¸°ì—ì„œ í™•ì¸í•˜ì„¸ìš”<br>
                            <strong>4ë‹¨ê³„:</strong> í•„ìš”ì‹œ í¸ì§‘ í›„ í•œê¸€ íŒŒì¼ë¡œ ë‚´ë³´ë‚´ì„¸ìš”
                        </p>
                        <div style="margin-top: 2rem; padding: 1rem; background: var(--bg-card); border-radius: 8px; border-left: 3px solid var(--accent-primary);">
                            <div style="font-size: 0.85rem; font-weight: 600; color: var(--accent-secondary); margin-bottom: 0.5rem;">ğŸ’¡ ì•ˆë‚´ì‚¬í•­</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); line-height: 1.6;">
                                â€¢ ë¶„ì„í‘œ íŒŒì¼ë§Œ ì—…ë¡œë“œí•˜ë©´ ëª¨ë“  ë³´ë„ìë£Œê°€ ìë™ ìƒì„±ë©ë‹ˆë‹¤<br>
                                â€¢ ë¯¸ë¦¬ë³´ê¸°ì—ì„œ ë‚´ìš©ì„ í™•ì¸í•˜ê³  ì§ì ‘ í¸ì§‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤<br>
                                â€¢ ë‚´ë³´ë‚´ê¸° ë²„íŠ¼ìœ¼ë¡œ í•œê¸€(HWP) íŒŒì¼ì— ë¶™ì—¬ë„£ì„ ìˆ˜ ìˆëŠ” HTMLì„ ìƒì„±í•©ë‹ˆë‹¤
                            </div>
                        </div>
                    </div>
                    <iframe class="preview-iframe" id="previewIframe" style="display: none;"></iframe>
                    <!-- í¸ì§‘ ëª¨ë“œìš© ì—ë””í„° -->
                    <div class="edit-container" id="editContainer" style="display: none;">
                        <div class="edit-toolbar">
                            <span class="edit-mode-badge">ğŸ“ í¸ì§‘ ëª¨ë“œ</span>
                            <span class="edit-hint">í…ìŠ¤íŠ¸ë¥¼ í´ë¦­í•˜ì—¬ ì§ì ‘ ìˆ˜ì •í•˜ì„¸ìš”. ë ˆì´ì•„ì›ƒì€ ìœ ì§€ë©ë‹ˆë‹¤.</span>
                        </div>
                        <div class="edit-content" id="editContent"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Contact Info Modal (ë‹´ë‹¹ë¶€ì„œ/ë‹´ë‹¹ì ì •ë³´ ì…ë ¥) -->
    <div class="modal-overlay" id="contactInfoModal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title">
                    <span>ğŸ“</span>
                    <span>ë‹´ë‹¹ë¶€ì„œ ë° ë‹´ë‹¹ì ì •ë³´</span>
                </h2>
                <button class="modal-close" onclick="closeContactModal()">Ã—</button>
            </div>
            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                ë³´ë„ìë£Œ í‘œì§€ì— í‘œì‹œë  ë‹´ë‹¹ë¶€ì„œ ë° ë‹´ë‹¹ì ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.
            </p>
            
            <!-- ë³´ë„ìë£Œ ì •ë³´ -->
            <div style="margin-bottom: 1.5rem;">
                <h3 style="font-size: 0.95rem; color: var(--accent-secondary); margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                    <span>ğŸ“…</span> ë³´ë„ìë£Œ ì •ë³´
                </h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="missing-field-item">
                        <label class="missing-field-label">ë³´ë„ì‹œì </label>
                        <input type="text" class="missing-field-input" id="releaseDateTime" 
                               placeholder="ì˜ˆ: 2025. 11. 17.(ì›”) 12:00" value="">
                    </div>
                    <div class="missing-field-item">
                        <label class="missing-field-label">ë°°í¬ì¼ì‹œ</label>
                        <input type="text" class="missing-field-input" id="distributionDateTime" 
                               placeholder="ì˜ˆ: 2025. 11. 17.(ì›”) 08:30" value="">
                    </div>
                </div>
            </div>
            
            <!-- ë‹´ë‹¹ë¶€ì„œ ì •ë³´ -->
            <div style="margin-bottom: 1.5rem;">
                <h3 style="font-size: 0.95rem; color: var(--accent-secondary); margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                    <span>ğŸ›ï¸</span> ë‹´ë‹¹ë¶€ì„œ
                </h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="missing-field-item">
                        <label class="missing-field-label">ë¶€ì„œëª…</label>
                        <input type="text" class="missing-field-input" id="department" 
                               placeholder="ì˜ˆ: êµ­ê°€ë°ì´í„°ì²˜ ê²½ì œí†µê³„êµ­" value="">
                    </div>
                    <div class="missing-field-item">
                        <label class="missing-field-label">ê³¼ëª…</label>
                        <input type="text" class="missing-field-input" id="division" 
                               placeholder="ì˜ˆ: ì†Œë“í†µê³„ê³¼" value="">
                    </div>
                </div>
            </div>
            
            <!-- ì±…ì„ì ì •ë³´ -->
            <div style="margin-bottom: 1.5rem;">
                <h3 style="font-size: 0.95rem; color: var(--accent-secondary); margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                    <span>ğŸ‘”</span> ì±…ì„ì ì •ë³´
                </h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                    <div class="missing-field-item">
                        <label class="missing-field-label">ì§ì±…</label>
                        <input type="text" class="missing-field-input" id="managerTitle" 
                               placeholder="ì˜ˆ: ê³¼ ì¥" value="">
                    </div>
                    <div class="missing-field-item">
                        <label class="missing-field-label">ì´ë¦„</label>
                        <input type="text" class="missing-field-input" id="managerName" 
                               placeholder="ì˜ˆ: í™ê¸¸ë™" value="">
                    </div>
                    <div class="missing-field-item">
                        <label class="missing-field-label">ì „í™”ë²ˆí˜¸</label>
                        <input type="text" class="missing-field-input" id="managerPhone" 
                               placeholder="ì˜ˆ: 042-481-2206" value="">
                    </div>
                </div>
            </div>
            
            <!-- ë‹´ë‹¹ì ì •ë³´ -->
            <div style="margin-bottom: 1.5rem;">
                <h3 style="font-size: 0.95rem; color: var(--accent-secondary); margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                    <span>ğŸ‘¤</span> ë‹´ë‹¹ì ì •ë³´
                </h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                    <div class="missing-field-item">
                        <label class="missing-field-label">ì§ì±…</label>
                        <input type="text" class="missing-field-input" id="staffTitle" 
                               placeholder="ì˜ˆ: ì‚¬ë¬´ê´€" value="">
                    </div>
                    <div class="missing-field-item">
                        <label class="missing-field-label">ì´ë¦„</label>
                        <input type="text" class="missing-field-input" id="staffName" 
                               placeholder="ì˜ˆ: ê¹€ì² ìˆ˜" value="">
                    </div>
                    <div class="missing-field-item">
                        <label class="missing-field-label">ì „í™”ë²ˆí˜¸</label>
                        <input type="text" class="missing-field-input" id="staffPhone" 
                               placeholder="ì˜ˆ: 042-481-2226" value="">
                    </div>
                </div>
            </div>
            
            <!-- ê´€ì„¸ì²­ ë‹´ë‹¹ ì •ë³´ -->
            <div style="margin-bottom: 1rem;">
                <h3 style="font-size: 0.95rem; color: var(--accent-secondary); margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                    <span>ğŸš¢</span> ê´€ì„¸ì²­ ë‹´ë‹¹ (ìˆ˜ì¶œì… í†µê³„)
                </h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="missing-field-item">
                        <label class="missing-field-label">ë‹´ë‹¹ë¶€ì„œ</label>
                        <input type="text" class="missing-field-input" id="customsDepartment" 
                               placeholder="ì˜ˆ: ê´€ì„¸ì²­ ì •ë³´ë°ì´í„°ê¸°íšë‹´ë‹¹ê´€" value="ê´€ì„¸ì²­ ì •ë³´ë°ì´í„°ê¸°íšë‹´ë‹¹ê´€">
                    </div>
                    <div class="missing-field-item">
                        <label class="missing-field-label">ì „í™”ë²ˆí˜¸</label>
                        <input type="text" class="missing-field-input" id="customsPhone" 
                               placeholder="ì˜ˆ: 042-481-7845" value="042-481-7845">
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeContactModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="saveContactInfo()">ğŸ’¾ ì €ì¥</button>
            </div>
        </div>
    </div>


    <!-- Upload Progress Modal -->
    <div class="upload-modal-overlay" id="uploadModal">
        <div class="upload-modal-content">
            <div class="upload-modal-icon" id="uploadModalIcon">ğŸ“¤</div>
            <h2 class="upload-modal-title" id="uploadModalTitle">íŒŒì¼ ì—…ë¡œë“œ ì¤‘</h2>
            <p class="upload-modal-subtitle" id="uploadModalSubtitle">íŒŒì¼ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
            
            <div class="upload-steps">
                <div class="upload-step" id="uploadStep1">
                    <span class="step-icon">â³</span>
                    <span class="step-text">íŒŒì¼ ì—…ë¡œë“œ</span>
                    <span class="step-status"></span>
                </div>
                <div class="upload-step" id="uploadStep2">
                    <span class="step-icon">â³</span>
                    <span class="step-text">ë¶„ì„í‘œ ì—…ë¡œë“œ</span>
                    <span class="step-status"></span>
                </div>
                <div class="upload-step" id="uploadStep4">
                    <span class="step-icon">â³</span>
                    <span class="step-text">ë³´ë„ìë£Œ ìƒì„± ì¤€ë¹„</span>
                    <span class="step-status"></span>
                </div>
            </div>
            
            <div class="upload-progress-bar">
                <div class="upload-progress-fill" id="uploadProgressFill"></div>
            </div>
            
            <div class="upload-result" id="uploadResult" style="display: none;">
                <div class="result-item">
                    <span class="result-label">ê¸°ì¤€ì‹œì :</span>
                    <span class="result-value" id="resultPeriod"></span>
                </div>
                <div class="result-item">
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay with Progress -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-icon" id="loadingIcon">ğŸ“Š</div>
            <h2 class="loading-title" id="loadingTitle">ë³´ë„ìë£Œ ìƒì„± ì¤‘</h2>
            <p class="loading-subtitle" id="loadingSubtitle">ëª¨ë“  ë³´ë„ìë£Œë¥¼ ë¯¸ë¦¬ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
            
            <div class="loading-progress-container">
                <div class="loading-progress-bar">
                    <div class="loading-progress-fill" id="loadingProgressFill" style="width: 0%;"></div>
                </div>
                <div class="loading-stats">
                    <span id="loadingProgressText">0 / 50</span>
                    <span id="loadingProgressPercent">0%</span>
                </div>
            </div>
            
            <div class="loading-current-item" id="loadingCurrentItem">
                <span class="loading-current-icon" id="loadingCurrentIcon">ğŸ“„</span>
                <span class="loading-current-text" id="loadingCurrentText">ì¤€ë¹„ ì¤‘...</span>
            </div>
            
            <div class="loading-time-container">
                <div class="loading-time-item">
                    <span class="loading-time-value" id="elapsedTime">00:00</span>
                    <span class="loading-time-label">ê²½ê³¼ ì‹œê°„</span>
                </div>
                <div class="loading-time-item" id="remainingTimeContainer" style="display: none;">
                    <span class="loading-time-value" id="remainingTime">--:--</span>
                    <span class="loading-time-label">ë‚¨ì€ ì‹œê°„</span>
                </div>
            </div>
        </div>
    </div>

    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        // State
        const state = {
            fileUploaded: false,
            allGenerated: false,
            currentReportIndex: -1,
            currentGlobalIndex: -1,  // ì „ì²´ ë³´ë„ìë£Œ í†µí•© ì¸ë±ìŠ¤
            currentPageInReport: 0,  // í˜„ì¬ ë³´ë„ìë£Œ ë‚´ í˜ì´ì§€ ì¸ë±ìŠ¤
            totalPagesInReport: 1,   // í˜„ì¬ ë³´ë„ìë£Œì˜ ì´ í˜ì´ì§€ ìˆ˜
            allReports: [],  // ëª¨ë“  ë³´ë„ìë£Œ í†µí•© ë°°ì—´
            fileType: 'analysis',  // ë¶„ì„í‘œë§Œ ì—…ë¡œë“œ
            reports: [],
            summaryReports: [],
            sectoralReports: [],
            regionalReports: [],
            statisticsReports: [],  // í†µê³„í‘œ ê¸°ëŠ¥ ë¹„í™œì„±í™”
            // ìºì‹œëœ HTML
            cachedHtml: {
                summary: {},
                sectoral: {},
                regional: {},
                statistics: {}
            },
            generatedReports: {
                summary: new Set(),
                sectoral: new Set(),
                regional: new Set(),
                statistics: new Set()
            },
            reviewedReports: {
                summary: new Set(),
                sectoral: new Set(),
                regional: new Set(),
                statistics: new Set()
            },
            editedReports: {
                summary: new Set(),
                sectoral: new Set(),
                regional: new Set(),
                statistics: new Set()
            },
            htmlCache: {},  // ìµœì¢… ë¬¸ì„œ ìƒì„±ìš© ìºì‹œ
            currentTab: 'summary',
            currentSummaryIndex: -1,
            currentRegionalIndex: -1,
            currentStatisticsIndex: -1,
            // ìƒì„± í†µê³„
            generationStats: {
                total: 0,
                completed: 0,
                failed: 0,
                startTime: null
            },
            // ë‹´ë‹¹ì ì •ë³´ (ê¸°ë³¸ê°’ ì—†ìŒ - ì‹¤ë¬´ìê°€ ì§ì ‘ ì…ë ¥í•´ì•¼ í•¨)
            contactInfo: {
                release_datetime: '',
                distribution_datetime: '',
                department: '',
                division: '',
                manager_title: '',
                manager_name: '',
                manager_phone: '',
                staff_title: '',
                staff_name: '',
                staff_phone: '',
                customs_department: '',
                customs_phone: ''
            },
        };

        // DOM Elements
        const elements = {
            uploadZone: document.getElementById('uploadZone'),
            fileInput: document.getElementById('fileInput'),
            uploadFilename: document.getElementById('uploadFilename'),
            allReportsList: document.getElementById('allReportsList'),
            reportCountBadge: document.getElementById('reportCountBadge'),
            // ê¸°ì¡´ í˜¸í™˜ì„± ìœ ì§€ (ë”ë¯¸)
            summaryReportList: { innerHTML: '', style: { display: 'flex' } },
            reportList: { innerHTML: '', style: { display: 'flex' } },
            regionalReportList: { innerHTML: '', style: { display: 'flex' } },
            statisticsReportList: { innerHTML: '', style: { display: 'flex' } },
            tabSummary: null,
            tabSectoral: null,
            tabRegional: null,
            tabStatistics: null,
            yearSelect: document.getElementById('yearSelect'),
            quarterSelect: document.getElementById('quarterSelect'),
            prevBtn: document.getElementById('prevBtn'),
            nextBtn: document.getElementById('nextBtn'),
            pageIndicator: document.getElementById('pageIndicator'),
            exportHwpReadyBtn: document.getElementById('exportHwpReadyBtn'),
            previewTitle: document.getElementById('previewTitle'),
            previewPlaceholder: document.getElementById('previewPlaceholder'),
            previewIframe: document.getElementById('previewIframe'),
            editContainer: document.getElementById('editContainer'),
            editContent: document.getElementById('editContent'),
            editBtn: document.getElementById('editBtn'),
            saveEditBtn: document.getElementById('saveEditBtn'),
            cancelEditBtn: document.getElementById('cancelEditBtn'),
            markReviewedBtn: document.getElementById('markReviewedBtn'),
            contactInfoModal: document.getElementById('contactInfoModal'),
            loadingOverlay: document.getElementById('loadingOverlay'),
            loadingTitle: document.getElementById('loadingTitle'),
            loadingSubtitle: document.getElementById('loadingSubtitle'),
            loadingIcon: document.getElementById('loadingIcon'),
            loadingProgressFill: document.getElementById('loadingProgressFill'),
            loadingProgressText: document.getElementById('loadingProgressText'),
            loadingProgressPercent: document.getElementById('loadingProgressPercent'),
            loadingCurrentIcon: document.getElementById('loadingCurrentIcon'),
            loadingCurrentText: document.getElementById('loadingCurrentText'),
            elapsedTime: document.getElementById('elapsedTime'),
            remainingTimeContainer: document.getElementById('remainingTimeContainer'),
            remainingTime: document.getElementById('remainingTime'),
            generationStatus: document.getElementById('generationStatus'),
            generationStatusCount: document.getElementById('generationStatusCount'),
            generationMiniFill: document.getElementById('generationMiniFill'),
            toastContainer: document.getElementById('toastContainer')
        };

        let timerInterval = null;
        let isEditMode = false;
        let originalHtmlBeforeEdit = null;
        let currentEditingReport = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', initApp);

        function initApp() {
            console.log('[ì´ˆê¸°í™”] ì•± ì´ˆê¸°í™” ì‹œì‘');
            setupEventListeners();
            loadReportList();
            renderAllReportsList(); // ì´ˆê¸° ë Œë”ë§
            
            // ì•Œë¦¼ ê¶Œí•œ ìš”ì²­ (ë¶„ì„ ì™„ë£Œ ì‹œ ì•Œë¦¼ìš©)
            requestNotificationPermission();
            console.log('[ì´ˆê¸°í™”] ì•± ì´ˆê¸°í™” ì™„ë£Œ');
        }

        function setupEventListeners() {
            // File upload - DOMì´ ë¡œë“œëœ í›„ ìš”ì†Œë¥¼ ë‹¤ì‹œ ì°¾ê¸°
            elements.uploadZone = document.getElementById('uploadZone');
            elements.fileInput = document.getElementById('fileInput');
            
            if (!elements.uploadZone || !elements.fileInput) {
                console.error('[ì´ˆê¸°í™”] ì—…ë¡œë“œ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', {
                    uploadZone: !!elements.uploadZone,
                    fileInput: !!elements.fileInput
                });
                return;
            }
            
            console.log('[ì´ˆê¸°í™”] ì—…ë¡œë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡');
            elements.uploadZone.addEventListener('click', () => {
                console.log('[ì—…ë¡œë“œ] ì—…ë¡œë“œ ì˜ì—­ í´ë¦­');
                if (elements.fileInput) {
                    elements.fileInput.click();
                } else {
                    console.error('[ì—…ë¡œë“œ] fileInputì´ ì—†ìŠµë‹ˆë‹¤.');
                }
            });
            elements.fileInput.addEventListener('change', (e) => {
                console.log('[ì—…ë¡œë“œ] íŒŒì¼ ì„ íƒ:', e.target.files[0]?.name);
                handleFileSelect(e);
            });
            elements.uploadZone.addEventListener('dragover', handleDragOver);
            elements.uploadZone.addEventListener('dragleave', handleDragLeave);
            elements.uploadZone.addEventListener('drop', handleDrop);

            // Navigation
            elements.prevBtn.addEventListener('click', () => navigateReport(-1));
            elements.nextBtn.addEventListener('click', () => navigateReport(1));

            // Actions
            elements.markReviewedBtn.addEventListener('click', markCurrentAsReviewed);
            elements.exportHwpReadyBtn.addEventListener('click', exportHwpReadyDocument);
            
            // Edit actions
            elements.editBtn.addEventListener('click', enterEditMode);
            elements.saveEditBtn.addEventListener('click', saveEditedContent);
            elements.cancelEditBtn.addEventListener('click', cancelEditMode);
        }

        function loadReportList() {
            fetch('/api/report-order')
                .then(res => res.json())
                .then(data => {
                    state.reports = data.reports;
                    state.summaryReports = data.reports.filter(r => r.category === 'summary');
                    state.sectoralReports = data.reports.filter(r => r.category !== 'summary');
                    state.regionalReports = data.regional_reports || [];
                    
                    // ì´ ë³´ë„ìë£Œ ìˆ˜ ê³„ì‚°
                    state.generationStats.total = 
                        state.summaryReports.length + 
                        state.sectoralReports.length + 
                        state.regionalReports.length + 
                        state.statisticsReports.length;
                    
                    // ì „ì²´ ë³´ë„ìë£Œ ë°°ì—´ ì´ˆê¸°í™” ë° ë Œë”ë§
                    initializeAllReports();
                    renderAllReportsList();
                })
                .catch(err => {
                    console.error('ë³´ë„ìë£Œ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', err);
                    showToast('ë³´ë„ìë£Œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                });
        }

        // ===== ë‹´ë‹¹ì ì •ë³´ ëª¨ë‹¬ í•¨ìˆ˜ =====
        function openContactModal() {
            document.getElementById('releaseDateTime').value = state.contactInfo.release_datetime;
            document.getElementById('distributionDateTime').value = state.contactInfo.distribution_datetime;
            document.getElementById('department').value = state.contactInfo.department;
            document.getElementById('division').value = state.contactInfo.division;
            document.getElementById('managerTitle').value = state.contactInfo.manager_title;
            document.getElementById('managerName').value = state.contactInfo.manager_name;
            document.getElementById('managerPhone').value = state.contactInfo.manager_phone;
            document.getElementById('staffTitle').value = state.contactInfo.staff_title;
            document.getElementById('staffName').value = state.contactInfo.staff_name;
            document.getElementById('staffPhone').value = state.contactInfo.staff_phone;
            document.getElementById('customsDepartment').value = state.contactInfo.customs_department || 'ê´€ì„¸ì²­ ì •ë³´ë°ì´í„°ê¸°íšë‹´ë‹¹ê´€';
            document.getElementById('customsPhone').value = state.contactInfo.customs_phone || '042-481-7845';
            
            elements.contactInfoModal.classList.add('active');
        }

        function closeContactModal() {
            elements.contactInfoModal.classList.remove('active');
        }

        function saveContactInfo() {
            state.contactInfo = {
                release_datetime: document.getElementById('releaseDateTime').value,
                distribution_datetime: document.getElementById('distributionDateTime').value,
                department: document.getElementById('department').value,
                division: document.getElementById('division').value,
                manager_title: document.getElementById('managerTitle').value,
                manager_name: document.getElementById('managerName').value,
                manager_phone: document.getElementById('managerPhone').value,
                staff_title: document.getElementById('staffTitle').value,
                staff_name: document.getElementById('staffName').value,
                staff_phone: document.getElementById('staffPhone').value,
                customs_department: document.getElementById('customsDepartment').value,
                customs_phone: document.getElementById('customsPhone').value
            };
            
            closeContactModal();
            showToast('ë‹´ë‹¹ì ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }


        // Tab switching
        function switchTab(tab) {
            state.currentTab = tab;
            
            elements.tabSummary.classList.toggle('active', tab === 'summary');
            elements.tabSectoral.classList.toggle('active', tab === 'sectoral');
            elements.tabRegional.classList.toggle('active', tab === 'regional');
            elements.tabStatistics.classList.toggle('active', tab === 'statistics');
            
            elements.summaryReportList.style.display = tab === 'summary' ? 'flex' : 'none';
            elements.reportList.style.display = tab === 'sectoral' ? 'flex' : 'none';
            elements.regionalReportList.style.display = tab === 'regional' ? 'flex' : 'none';
            elements.statisticsReportList.style.display = tab === 'statistics' ? 'flex' : 'none';
            
            updatePageIndicator();
            updateNavigationButtons();
        }

        // ===== ë¯¸ë¦¬ë³´ê¸° ìƒì„± =====
        async function generateAllReports() {
            if (!state.fileUploaded) {
                showToast('ë¨¼ì € ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.', 'warning');
                return;
            }

            // ì´ˆê¸°í™”
            state.generationStats.completed = 0;
            state.generationStats.failed = 0;
            state.generationStats.startTime = Date.now();
            
            showLoadingProgress();
            startTimer();

            const allItems = [
                ...state.summaryReports.map(r => ({ type: 'summary', report: r })),
                ...state.sectoralReports.map(r => ({ type: 'sectoral', report: r })),
                ...state.regionalReports.map(r => ({ type: 'regional', report: r }))
                // í†µê³„í‘œ ê¸°ëŠ¥ ë¹„í™œì„±í™” - statisticsReports ì œì™¸
            ];

            for (let i = 0; i < allItems.length; i++) {
                const item = allItems[i];
                
                // í†µê³„í‘œ ê±´ë„ˆë›°ê¸° í•„í„°ë§
                if (item.type === 'statistics') {
                    console.log('[ê±´ë„ˆë›°ê¸°] í†µê³„í‘œëŠ” ìƒì„±í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤:', item.report.name);
                    continue;
                }
                
                const progress = ((i + 1) / allItems.length) * 100;
                
                // í˜„ì¬ í•­ëª© í‘œì‹œ
                updateLoadingProgress(i + 1, allItems.length, item.report.icon || 'ğŸ“„', item.report.name);
                
                try {
                    const result = await generateSingleReport(item.type, item.report);
                    if (result && result.success) {
                        state.generationStats.completed++;
                    } else {
                        console.error(`[ë³´ë„ìë£Œ ìƒì„± ì‹¤íŒ¨] ${item.report.name} (${item.type}):`, result?.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
                        state.generationStats.failed++;
                    }
                } catch (err) {
                    console.error(`[ë³´ë„ìë£Œ ìƒì„± ì˜ˆì™¸] ${item.report.name} (${item.type}):`, err);
                    state.generationStats.failed++;
                }
            }

            stopTimer();
            hideLoading();
            
            // ìƒì„± ì™„ë£Œ ìƒíƒœ í‘œì‹œ
            state.allGenerated = true;
            showGenerationStatus();
            
            // í•œê¸€ ë¶ˆëŸ¬ì˜¤ê¸°ìš© HTML ë‚´ë³´ë‚´ê¸° ë²„íŠ¼ í‘œì‹œ ë° í™œì„±í™”
            if (elements.exportHwpReadyBtn) {
                elements.exportHwpReadyBtn.style.display = 'inline-flex';
                elements.exportHwpReadyBtn.disabled = false;
                elements.exportHwpReadyBtn.style.opacity = '1';
                elements.exportHwpReadyBtn.style.cursor = 'pointer';
                console.log('[ì¶œë ¥] í•œê¸€ ë¶ˆëŸ¬ì˜¤ê¸°ìš© HTML ì¶œë ¥ ë²„íŠ¼ í™œì„±í™”');
            }
            
            // ì „ì²´ ë³´ë„ìë£Œ ë°°ì—´ ì´ˆê¸°í™” ë° ë Œë”ë§
            initializeAllReports();
            renderAllReportsList();
            
            // ì²« ë²ˆì§¸ ë³´ë„ìë£Œ ìë™ ì„ íƒ
            if (state.allReports.length > 0) {
                selectGlobalReport(0);
            }
            
            showToast(`âœ… ì „ì²´ ${state.generationStats.completed}ê°œ ë³´ë„ìë£Œ ìƒì„± ì™„ë£Œ!`, 'success');
            
            // ì‹œìŠ¤í…œ ì•Œë¦¼: ë¯¸ë¦¬ë³´ê¸° ìƒì„± ì™„ë£Œ
            sendSystemNotification('ğŸ“‹ ë¯¸ë¦¬ë³´ê¸° ìƒì„± ì™„ë£Œ', `${state.generationStats.completed}ê°œ ë³´ë„ìë£Œ ë¯¸ë¦¬ë³´ê¸° ìƒì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`);
        }
        
        // ì‹œìŠ¤í…œ ì•Œë¦¼ ê¶Œí•œ ìš”ì²­ ë° ì•Œë¦¼ ë³´ë‚´ê¸°
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }
        
        function sendSystemNotification(title, body) {
            // ë¸Œë¼ìš°ì € ì•Œë¦¼ API ì§€ì› í™•ì¸
            if (!('Notification' in window)) {
                console.log('ì´ ë¸Œë¼ìš°ì €ëŠ” ì•Œë¦¼ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ì•Œë¦¼ ê¶Œí•œì´ í—ˆìš©ëœ ê²½ìš°
            if (Notification.permission === 'granted') {
                const notification = new Notification(title, {
                    body: body,
                    icon: 'ğŸ“Š',
                    badge: 'ğŸ“Š',
                    tag: 'analysis-complete',
                    requireInteraction: false
                });
                
                // 3ì´ˆ í›„ ìë™ ë‹«ê¸°
                setTimeout(() => notification.close(), 5000);
                
                // ì•Œë¦¼ í´ë¦­ ì‹œ ì°½ í¬ì»¤ìŠ¤
                notification.onclick = function() {
                    window.focus();
                    notification.close();
                };
            } 
            // ì•Œë¦¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì§€ ì•Šì€ ê²½ìš° ê¶Œí•œ ìš”ì²­
            else if (Notification.permission !== 'denied') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        sendSystemNotification(title, body);
                    }
                });
            }
            
            // ì‚¬ìš´ë“œ ì•Œë¦¼ (ì„ íƒì )
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2teleAAAJofI4PKuahEEOnLY8PnLeBMAAFrQ9//tjhAAAD7l//+9cwAAAEDz//+uZgAAOPz//6dbAAAs////nVEAACP///+TRwAAHv///4s9AAAb////hDQAABn///9+LAAA');
                audio.volume = 0.3;
                audio.play().catch(() => {});
            } catch (e) {}
        }

        async function generateSingleReport(type, report) {
            // year/quarter ìœ íš¨ì„± ê²€ì‚¬ - NaNì´ê±°ë‚˜ ì—†ìœ¼ë©´ undefinedë¡œ ì„¤ì • (ì„œë²„ì—ì„œ ì¶”ì¶œí•˜ë„ë¡)
            let year = parseInt(elements.yearSelect.value);
            let quarter = parseInt(elements.quarterSelect.value);
            
            // NaNì´ë©´ undefinedë¡œ ì„¤ì • (ì„œë²„ì—ì„œ ì„¸ì…˜ì´ë‚˜ ë°ì´í„°ì—ì„œ ì¶”ì¶œí•˜ë„ë¡)
            if (isNaN(year)) year = undefined;
            if (isNaN(quarter)) quarter = undefined;
            
            let endpoint, body;
            
            switch (type) {
                case 'summary':
                    endpoint = '/api/generate-summary-preview';
                    body = {
                        report_id: report.id,
                        year, quarter,
                        contact_info: state.contactInfo
                    };
                    break;
                case 'sectoral':
                    endpoint = '/api/generate-preview';
                    body = { report_id: report.id, year, quarter };
                    break;
                case 'regional':
                    endpoint = '/api/generate-regional-preview';
                    body = { region_id: report.id };
                    break;
                case 'statistics':
                    // í†µê³„í‘œ ê¸°ëŠ¥ ë¹„í™œì„±í™” - ìš”ì²­ ê±´ë„ˆë›°ê¸°
                    console.log('[í†µê³„í‘œ ê±´ë„ˆë›°ê¸°] í†µê³„í‘œ ìƒì„± ê¸°ëŠ¥ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤:', report.name);
                    return { success: false, error: 'í†µê³„í‘œ ìƒì„± ê¸°ëŠ¥ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.' };
            }

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                // ì‘ë‹µ ìƒíƒœ í™•ì¸
                if (!response.ok) {
                    let errorData;
                    try {
                        errorData = await response.json();
                    } catch (e) {
                        errorData = { success: false, error: `HTTP ${response.status}: ${response.statusText}` };
                    }
                    console.error(`[ë³´ë„ìë£Œ ìƒì„± ì‹¤íŒ¨] ${report.name} (${type}):`, errorData.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
                    return errorData;
                }

                const data = await response.json();

                if (data.success) {
                    // HTML ìºì‹±
                    state.cachedHtml[type][report.id] = data.html;
                    state.htmlCache[`${type}_${report.id}`] = data.html;  // ìµœì¢… ë¬¸ì„œìš© ìºì‹œ
                    state.generatedReports[type].add(report.id);
                } else {
                    console.error(`[ë³´ë„ìë£Œ ìƒì„± ì‹¤íŒ¨] ${report.name} (${type}):`, data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
                }
                
                return data;
            } catch (err) {
                console.error(`[ë³´ë„ìë£Œ ìƒì„± ì˜ˆì™¸] ${report.name} (${type}):`, err);
                return { success: false, error: `ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${err.message}` };
            }
        }

        // ===== ë¡œë”© ì§„í–‰ë¥  í‘œì‹œ =====
        function showLoadingProgress() {
            elements.loadingOverlay.classList.add('active');
        }

        function updateLoadingProgress(current, total, icon, name) {
            const percent = Math.round((current / total) * 100);
            
            elements.loadingProgressFill.style.width = `${percent}%`;
            elements.loadingProgressText.textContent = `${current} / ${total}`;
            elements.loadingProgressPercent.textContent = `${percent}%`;
            elements.loadingCurrentIcon.textContent = icon;
            elements.loadingCurrentText.textContent = name;
        }

        // ===== ì²˜ë¦¬ ì‹œê°„ ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° (localStorage) =====
        const PROCESSING_TIME_KEY = 'reportGenerationTime';
        
        function saveProcessingTime(durationMs) {
            const record = {
                duration: durationMs,
                reportCount: state.generationStats.total,
                timestamp: Date.now()
            };
            localStorage.setItem(PROCESSING_TIME_KEY, JSON.stringify(record));
        }
        
        function getEstimatedTime() {
            try {
                const saved = localStorage.getItem(PROCESSING_TIME_KEY);
                if (saved) {
                    const record = JSON.parse(saved);
                    return record;
                }
            } catch (e) {
                console.warn('ì²˜ë¦¬ ì‹œê°„ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', e);
            }
            return null;
        }
        
        function formatTime(ms) {
            const totalSec = Math.floor(ms / 1000);
            const min = Math.floor(totalSec / 60);
            const sec = totalSec % 60;
            return `${String(min).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
        }

        function startTimer() {
            // ë‚¨ì€ ì‹œê°„ ê³„ì‚°ìš© ì˜ˆìƒ ì‹œê°„ ì„¤ì •
            const estimated = getEstimatedTime();
            if (estimated && estimated.duration) {
                elements.remainingTimeContainer.style.display = 'flex';
                state.estimatedDuration = estimated.duration;
            } else {
                elements.remainingTimeContainer.style.display = 'none';
                state.estimatedDuration = null;
            }
            
            timerInterval = setInterval(() => {
                const elapsed = Date.now() - state.generationStats.startTime;
                elements.elapsedTime.textContent = formatTime(elapsed);
                
                // ë‚¨ì€ ì‹œê°„ ê³„ì‚° (ì˜ˆìƒ ì‹œê°„ì´ ìˆëŠ” ê²½ìš°)
                if (state.estimatedDuration) {
                    const remaining = Math.max(0, state.estimatedDuration - elapsed);
                    elements.remainingTime.textContent = formatTime(remaining);
                    
                    // ì‹œê°„ ì´ˆê³¼ ì‹œ ìŠ¤íƒ€ì¼ ë³€ê²½
                    if (remaining === 0) {
                        elements.remainingTime.style.color = 'var(--warning)';
                        elements.remainingTime.textContent = '+' + formatTime(elapsed - state.estimatedDuration);
                    } else {
                        elements.remainingTime.style.color = '';
                    }
                }
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            // ì²˜ë¦¬ ì‹œê°„ ì €ì¥
            if (state.generationStats.startTime) {
                const duration = Date.now() - state.generationStats.startTime;
                saveProcessingTime(duration);
            }
        }

        function hideLoading() {
            elements.loadingOverlay.classList.remove('active');
        }

        function showGenerationStatus() {
            const total = state.generationStats.total;
            const completed = state.generationStats.completed;
            
            elements.generationStatus.classList.add('active');
            elements.generationStatusCount.textContent = `${completed}/${total}`;
            elements.generationMiniFill.style.width = `${(completed / total) * 100}%`;
        }

        // ===== ë³´ë„ìë£Œ ì„ íƒ (ìºì‹œì—ì„œ í‘œì‹œ) =====
        function selectSummaryReport(index) {
            // globalIndexë¡œ ë³€í™˜í•˜ì—¬ í˜¸ì¶œ
            const globalIndex = state.allReports.findIndex(r => r.type === 'summary' && r.originalIndex === index);
            if (globalIndex >= 0) {
                selectGlobalReport(globalIndex);
            }
        }

        function selectReport(index) {
            // globalIndexë¡œ ë³€í™˜í•˜ì—¬ í˜¸ì¶œ
            const globalIndex = state.allReports.findIndex(r => r.type === 'sectoral' && r.originalIndex === index);
            if (globalIndex >= 0) {
                selectGlobalReport(globalIndex);
            }
        }

        function selectRegionalReport(index) {
            // globalIndexë¡œ ë³€í™˜í•˜ì—¬ í˜¸ì¶œ
            const globalIndex = state.allReports.findIndex(r => r.type === 'regional' && r.originalIndex === index);
            if (globalIndex >= 0) {
                selectGlobalReport(globalIndex);
            }
        }

        function selectStatisticsReport(index) {
            // globalIndexë¡œ ë³€í™˜í•˜ì—¬ í˜¸ì¶œ
            const globalIndex = state.allReports.findIndex(r => r.type === 'statistics' && r.originalIndex === index);
            if (globalIndex >= 0) {
                selectGlobalReport(globalIndex);
            }
        }

        function displayCachedReport(type, report, pageIndex = 0) {
            const html = state.cachedHtml[type][report.id];
            
            if (html) {
                // í¸ì§‘ ëª¨ë“œ ì¢…ë£Œ
                if (isEditMode) {
                    exitEditMode();
                }
                
                // HTMLì—ì„œ í˜ì´ì§€(.page) ìš”ì†Œë“¤ ì¶”ì¶œ
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const pages = doc.querySelectorAll('.page');
                
                state.totalPagesInReport = Math.max(1, pages.length);
                state.currentPageInReport = Math.min(pageIndex, state.totalPagesInReport - 1);
                
                let displayHtml = html;
                
                // í˜ì´ì§€ê°€ ì—¬ëŸ¬ ê°œì¸ ê²½ìš° í˜„ì¬ í˜ì´ì§€ë§Œ í‘œì‹œ
                if (pages.length > 1) {
                    const currentPage = pages[state.currentPageInReport];
                    if (currentPage) {
                        // ì›ë³¸ HTMLì˜ head ìœ ì§€í•˜ê³  bodyëŠ” í˜„ì¬ í˜ì´ì§€ë§Œ
                        const headContent = doc.head.innerHTML;
                        displayHtml = `<!DOCTYPE html>
<html lang="ko">
<head>${headContent}</head>
<body style="margin: 0; padding: 0; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; background: #f5f5f5;">
${currentPage.outerHTML}
</body>
</html>`;
                    }
                }
                
                elements.previewPlaceholder.style.display = 'none';
                elements.editContainer.style.display = 'none';
                elements.previewIframe.style.display = 'block';
                elements.previewIframe.srcdoc = displayHtml;
                
                // ì œëª©ì— í˜ì´ì§€ ì •ë³´ í‘œì‹œ
                const pageInfo = state.totalPagesInReport > 1 ? ` (${state.currentPageInReport + 1}/${state.totalPagesInReport})` : '';
                elements.previewTitle.innerHTML = `<span>${report.icon || 'ğŸ“„'}</span><span>${report.name}${pageInfo}</span>`;
                
                // í¸ì§‘/ê²€í†  ë²„íŠ¼ í‘œì‹œ
                elements.editBtn.style.display = 'inline-flex';
                elements.saveEditBtn.style.display = 'none';
                elements.cancelEditBtn.style.display = 'none';
                elements.markReviewedBtn.style.display = 'block';
                
                updateNavigationButtons();
                updatePageIndicator();
            } else {
                showToast('ë³´ë„ìë£Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ===== ë Œë”ë§ í•¨ìˆ˜ë“¤ =====
        // ì „ì²´ ë³´ë„ìë£Œ í†µí•© ë°°ì—´ ì´ˆê¸°í™”
        function initializeAllReports() {
            state.allReports = [
                ...state.summaryReports.map((r, idx) => ({ ...r, type: 'summary', originalIndex: idx })),
                ...state.sectoralReports.map((r, idx) => ({ ...r, type: 'sectoral', originalIndex: idx })),
                ...state.regionalReports.map((r, idx) => ({ ...r, type: 'regional', originalIndex: idx, name: `${r.index}. ${r.name}`, sheet: r.full_name }))
                // í†µê³„í‘œ ê¸°ëŠ¥ ë¹„í™œì„±í™” - statisticsReports ì œì™¸
            ];
            if (elements.reportCountBadge) {
                elements.reportCountBadge.textContent = `(ì´ ${state.allReports.length}ê°œ)`;
            }
        }

        // ì „ì²´ ë³´ë„ìë£Œ í†µí•© ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
        function renderAllReportsList() {
            if (!elements.allReportsList) return;
            
            // íŒŒì¼ì´ ì—…ë¡œë“œë˜ì§€ ì•Šì•˜ê±°ë‚˜ ê¸°ì´ˆìë£Œì¸ ê²½ìš° ì´ˆê¸° ì•ˆë‚´ í‘œì‹œ
            if (!state.fileUploaded) {
                elements.allReportsList.innerHTML = `
                    <div style="padding: 1.5rem; text-align: center; color: var(--text-secondary);">
                        <div style="font-size: 2rem; margin-bottom: 0.75rem;">ğŸ“</div>
                        <div style="font-size: 0.85rem; font-weight: 600; margin-bottom: 0.5rem;">íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</div>
                        <div style="font-size: 0.75rem; line-height: 1.5; color: var(--text-muted);">
                            â€¢ <strong style="color: var(--success);">ë¶„ì„í‘œ</strong> ì—…ë¡œë“œ â†’ ë³´ë„ìë£Œ ìƒì„±
                        </div>
                    </div>
                `;
                return;
            }
            
            // ë³´ë„ìë£Œ ëª©ë¡ ë Œë”ë§
            
            let currentSection = '';
            let html = '';
            
            state.allReports.forEach((report, globalIdx) => {
                // í†µê³„í‘œ ê±´ë„ˆë›°ê¸° í•„í„°ë§
                if (report.type === 'statistics') {
                    return;  // continueì™€ ë™ì¼í•˜ê²Œ ì‘ë™
                }
                
                // ì„¹ì…˜ í—¤ë” ì¶”ê°€
                const sectionNames = { summary: 'ğŸ“‹ ìš”ì•½', sectoral: 'ğŸ“Š ë¶€ë¬¸ë³„', regional: 'ğŸ—ºï¸ ì‹œë„ë³„' };
                if (report.type !== currentSection) {
                    currentSection = report.type;
                    html += `<div style="font-size: 0.75rem; color: var(--accent-primary); padding: 0.5rem 0.75rem; margin-top: ${globalIdx > 0 ? '0.5rem' : '0'}; background: rgba(99, 102, 241, 0.1); border-radius: 4px;">${sectionNames[report.type]}</div>`;
                }
                
                const isActive = globalIdx === state.currentGlobalIndex;
                const isGenerated = state.generatedReports[report.type].has(report.id);
                const isReviewed = state.reviewedReports[report.type].has(report.id);
                const isEdited = state.editedReports[report.type].has(report.id);
                
                let statusClass = 'pending';
                let statusIcon = 'â—‹';
                if (isReviewed) {
                    statusClass = 'reviewed';
                    statusIcon = 'âœ“';
                } else if (isEdited) {
                    statusClass = 'edited';
                    statusIcon = 'âœï¸';
                } else if (isGenerated) {
                    statusClass = 'generated';
                    statusIcon = 'â—';
                }

                html += `
                    <div class="report-item ${isActive ? 'active' : ''} ${isGenerated ? 'generated' : ''} ${isReviewed ? 'reviewed' : ''} ${isEdited ? 'edited' : ''}"
                         onclick="selectGlobalReport(${globalIdx})"
                         data-report-id="${report.id}"
                         data-global-index="${globalIdx}">
                        <div class="report-item-header">
                        <div class="report-icon">${report.icon}</div>
                        <div class="report-info">
                            <div class="report-name">${report.name}</div>
                        </div>
                        <div class="report-status ${statusClass}">${statusIcon}</div>
                        </div>
                    </div>
                `;
            });
            
            elements.allReportsList.innerHTML = html;
            
            // í˜„ì¬ ì„ íƒëœ í•­ëª©ìœ¼ë¡œ ìŠ¤í¬ë¡¤
            if (state.currentGlobalIndex >= 0) {
                const activeItem = elements.allReportsList.querySelector(`[data-global-index="${state.currentGlobalIndex}"]`);
                if (activeItem) {
                    activeItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }
        }

        // ì „ì²´ ë³´ë„ìë£Œ ì„ íƒ í•¨ìˆ˜
        function selectGlobalReport(globalIndex, pageIndex = 0) {
            if (!state.allGenerated) {
                showToast('ë³´ë„ìë£Œ ìƒì„± ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.', 'info');
                return;
            }
            
            if (globalIndex < 0 || globalIndex >= state.allReports.length) return;
            
            state.currentGlobalIndex = globalIndex;
            const report = state.allReports[globalIndex];
            
            // ê¸°ì¡´ ì¸ë±ìŠ¤ë„ ë™ê¸°í™”
            state.currentSummaryIndex = report.type === 'summary' ? report.originalIndex : -1;
            state.currentReportIndex = report.type === 'sectoral' ? report.originalIndex : -1;
            state.currentRegionalIndex = report.type === 'regional' ? report.originalIndex : -1;
            state.currentStatisticsIndex = report.type === 'statistics' ? report.originalIndex : -1;
            state.currentTab = report.type;
            
            // pageIndexê°€ -1ì´ë©´ ë§ˆì§€ë§‰ í˜ì´ì§€ë¡œ ì´ë™
            let targetPage = pageIndex;
            if (pageIndex === -1) {
                const html = state.cachedHtml[report.type] && state.cachedHtml[report.type][report.id];
                if (html) {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    targetPage = Math.max(0, doc.querySelectorAll('.page').length - 1);
                } else {
                    targetPage = 0;
                }
            }
            
            displayCachedReport(report.type, report, targetPage);
            renderAllReportsList();
            updateNavigationButtons();
            updatePageIndicator();
        }

        // ê¸°ì¡´ í˜¸í™˜ì„±ì„ ìœ„í•œ í•¨ìˆ˜ë“¤ (ë‚´ë¶€ì ìœ¼ë¡œ globalIndex ì‚¬ìš©)
        function renderSummaryReportList() { renderAllReportsList(); }
        function renderReportList() { renderAllReportsList(); }
        function renderRegionalReportList() { renderAllReportsList(); }
        function renderStatisticsReportList() { renderAllReportsList(); }

        // ===== ë„¤ë¹„ê²Œì´ì…˜ =====
        function navigateReport(direction) {
            if (direction > 0) {
                // ë‹¤ìŒ í˜ì´ì§€/ë³´ë„ìë£Œ
                if (state.currentPageInReport < state.totalPagesInReport - 1) {
                    // ê°™ì€ ë³´ë„ìë£Œ ë‚´ ë‹¤ìŒ í˜ì´ì§€
                    const report = state.allReports[state.currentGlobalIndex];
                    displayCachedReport(report.type, report, state.currentPageInReport + 1);
                } else {
                    // ë‹¤ìŒ ë³´ë„ìë£Œì˜ ì²« í˜ì´ì§€
                    const newIndex = state.currentGlobalIndex + 1;
                    if (newIndex < state.allReports.length) {
                        selectGlobalReport(newIndex, 0);
                    }
                }
            } else {
                // ì´ì „ í˜ì´ì§€/ë³´ë„ìë£Œ
                if (state.currentPageInReport > 0) {
                    // ê°™ì€ ë³´ë„ìë£Œ ë‚´ ì´ì „ í˜ì´ì§€
                    const report = state.allReports[state.currentGlobalIndex];
                    displayCachedReport(report.type, report, state.currentPageInReport - 1);
                } else {
                    // ì´ì „ ë³´ë„ìë£Œì˜ ë§ˆì§€ë§‰ í˜ì´ì§€
                    const newIndex = state.currentGlobalIndex - 1;
                    if (newIndex >= 0) {
                        selectGlobalReport(newIndex, -1);  // -1ì€ ë§ˆì§€ë§‰ í˜ì´ì§€ë¥¼ ì˜ë¯¸
                    }
                }
            }
        }

        function updateNavigationButtons() {
            // ì²« ë³´ë„ìë£Œì˜ ì²« í˜ì´ì§€ì´ë©´ ì´ì „ ë²„íŠ¼ ë¹„í™œì„±í™”
            const isFirstPage = state.currentGlobalIndex <= 0 && state.currentPageInReport <= 0;
            // ë§ˆì§€ë§‰ ë³´ë„ìë£Œì˜ ë§ˆì§€ë§‰ í˜ì´ì§€ì´ë©´ ë‹¤ìŒ ë²„íŠ¼ ë¹„í™œì„±í™”
            const isLastPage = state.currentGlobalIndex >= state.allReports.length - 1 && 
                              state.currentPageInReport >= state.totalPagesInReport - 1;
            
            elements.prevBtn.disabled = isFirstPage;
            elements.nextBtn.disabled = isLastPage;
        }

        function updatePageIndicator() {
            // ì „ì²´ í˜ì´ì§€ ë²ˆí˜¸ ê³„ì‚° (ëª¨ë“  ë³´ë„ìë£Œì˜ ëª¨ë“  í˜ì´ì§€)
            let totalPages = 0;
            let currentPage = 0;
            
            for (let i = 0; i < state.allReports.length; i++) {
                const report = state.allReports[i];
                const html = state.cachedHtml[report.type] && state.cachedHtml[report.type][report.id];
                let pageCount = 1;
                
                if (html) {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    pageCount = Math.max(1, doc.querySelectorAll('.page').length);
                }
                
                if (i < state.currentGlobalIndex) {
                    currentPage += pageCount;
                } else if (i === state.currentGlobalIndex) {
                    currentPage += state.currentPageInReport + 1;
                }
                totalPages += pageCount;
            }
            
            elements.pageIndicator.textContent = `${currentPage > 0 ? currentPage : 0} / ${totalPages}`;
        }

        // ===== ê²€í†  ì™„ë£Œ =====
        function markCurrentAsReviewed() {
            if (state.currentGlobalIndex < 0 || state.currentGlobalIndex >= state.allReports.length) {
                return;
            }
            
            const report = state.allReports[state.currentGlobalIndex];
            state.reviewedReports[report.type].add(report.id);
            
            // iframe ë‚´ placeholder í•˜ì´ë¼ì´íŠ¸ ì œê±°
            try {
                const iframe = elements.previewIframe;
                if (iframe && iframe.contentDocument) {
                    const placeholders = iframe.contentDocument.querySelectorAll('.placeholder');
                    placeholders.forEach(el => {
                        el.classList.remove('placeholder');
                        el.removeAttribute('contenteditable');
                        el.style.backgroundColor = '';
                        el.style.border = '';
                    });
                    
                    // ìˆ˜ì •ëœ HTMLì„ ìºì‹œì— ì €ì¥
                    const cacheKey = `${report.type}_${report.id}`;
                    state.htmlCache[cacheKey] = iframe.contentDocument.documentElement.outerHTML;
                }
            } catch (e) {
                console.warn('í”Œë ˆì´ìŠ¤í™€ë” í•˜ì´ë¼ì´íŠ¸ ì œê±° ì‹¤íŒ¨:', e);
            }
            
            renderAllReportsList();
            
            showToast(`${report.name} ê²€í†  ì™„ë£Œ`, 'success');
            navigateReport(1); // ë‹¤ìŒìœ¼ë¡œ ìë™ ì´ë™
        }

        // ===== íŒŒì¼ ì—…ë¡œë“œ =====
        function handleDragOver(e) {
            e.preventDefault();
            elements.uploadZone.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            elements.uploadZone.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            elements.uploadZone.classList.remove('dragover');
            
            const file = e.dataTransfer.files[0];
            if (file) uploadFile(file);
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            console.log('[ì—…ë¡œë“œ] handleFileSelect í˜¸ì¶œ, íŒŒì¼:', file?.name);
            if (file) {
                uploadFile(file);
            } else {
                console.warn('[ì—…ë¡œë“œ] íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
            }
        }

        // ì—…ë¡œë“œ ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜
        function showUploadModal() {
            const modal = document.getElementById('uploadModal');
            modal.classList.add('active');
            
            // ì´ˆê¸°í™”
            document.getElementById('uploadModalIcon').textContent = 'ğŸ“¤';
            document.getElementById('uploadModalTitle').textContent = 'íŒŒì¼ ì—…ë¡œë“œ ì¤‘';
            document.getElementById('uploadModalSubtitle').textContent = 'íŒŒì¼ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...';
            document.getElementById('uploadProgressFill').style.width = '0%';
            document.getElementById('uploadResult').style.display = 'none';
            
            // ëª¨ë“  ìŠ¤í… ì´ˆê¸°í™” ë° í‘œì‹œ
            ['uploadStep1', 'uploadStep2', 'uploadStep4'].forEach(id => {
                const step = document.getElementById(id);
                step.className = 'upload-step';
                step.style.display = ''; // í‘œì‹œ ìƒíƒœë¡œ ì´ˆê¸°í™”
                step.querySelector('.step-icon').textContent = 'â³';
                step.querySelector('.step-status').textContent = '';
            });
        }
        
        function updateUploadStep(stepNum, status, statusText = '') {
            const step = document.getElementById(`uploadStep${stepNum}`);
            const icon = step.querySelector('.step-icon');
            const statusEl = step.querySelector('.step-status');
            
            step.className = 'upload-step';
            
            if (status === 'active') {
                step.classList.add('active');
                icon.textContent = 'ğŸ”„';
                statusEl.textContent = 'ì§„í–‰ ì¤‘...';
            } else if (status === 'completed') {
                step.classList.add('completed');
                icon.textContent = 'âœ…';
                statusEl.textContent = statusText || 'ì™„ë£Œ';
            } else if (status === 'skipped') {
                step.classList.add('skipped');
                icon.textContent = 'â­ï¸';
                statusEl.textContent = 'ê±´ë„ˆëœ€';
            } else if (status === 'error') {
                step.classList.add('error');
                icon.textContent = 'âŒ';
                statusEl.textContent = statusText || 'ì‹¤íŒ¨';
            }
            
            // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ (3ë‹¨ê³„ ê¸°ì¤€)
            const totalSteps = 3;
            const progress = (stepNum / totalSteps) * 100;
            document.getElementById('uploadProgressFill').style.width = `${progress}%`;
        }
        
        function hideUploadModal(delay = 0) {
            setTimeout(() => {
                document.getElementById('uploadModal').classList.remove('active');
            }, delay);
        }

        async function uploadFile(file) {
            console.log('[ì—…ë¡œë“œ] uploadFile ì‹œì‘:', file.name);
            
            if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
                console.error('[ì—…ë¡œë“œ] ì˜ëª»ëœ íŒŒì¼ í˜•ì‹:', file.name);
                showToast('ì—‘ì…€ íŒŒì¼(.xlsx, .xls)ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.', 'error');
                return;
            }

            // ì—…ë¡œë“œ ëª¨ë‹¬ í‘œì‹œ
            console.log('[ì—…ë¡œë“œ] ì—…ë¡œë“œ ëª¨ë‹¬ í‘œì‹œ');
            showUploadModal();
            
            // Step 1: íŒŒì¼ ì—…ë¡œë“œ
            updateUploadStep(1, 'active');
            
            const formData = new FormData();
            formData.append('file', file);

            try {
                // Step 1 ì™„ë£Œ
                await new Promise(r => setTimeout(r, 300));
                updateUploadStep(1, 'completed', file.name);
                
                // Step 2: ë¶„ì„í‘œ ì—…ë¡œë“œ
                updateUploadStep(2, 'active');
                document.getElementById('uploadModalSubtitle').textContent = 'ë¶„ì„í‘œë¥¼ ì—…ë¡œë“œí•˜ê³  ìˆìŠµë‹ˆë‹¤...';
                
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    // Step 2 ì™„ë£Œ
                    updateUploadStep(2, 'completed', 'ë¶„ì„í‘œ');
                    
                    // ì™„ë£Œ ìƒíƒœ í‘œì‹œ
                    document.getElementById('uploadModalIcon').textContent = 'âœ…';
                    document.getElementById('uploadModalTitle').textContent = 'ì—…ë¡œë“œ ì™„ë£Œ!';
                    document.getElementById('uploadModalSubtitle').textContent = 'íŒŒì¼ ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';
                    // ì§„í–‰ë¥ ì€ updateUploadStepì—ì„œ ìë™ ê³„ì‚°ë¨
                    
                    // ê²°ê³¼ í‘œì‹œ
                    const resultDiv = document.getElementById('uploadResult');
                    resultDiv.style.display = 'block';
                    document.getElementById('resultPeriod').textContent = `${data.year}ë…„ ${data.quarter}ë¶„ê¸°`;
                    
                    // ê¸°ì¡´ UI ì—…ë°ì´íŠ¸
                    state.fileUploaded = true;
                    state.fileType = 'analysis';
                    
                    elements.uploadZone.classList.add('uploaded');
                    elements.uploadFilename.textContent = `âœ“ ${data.filename}`;
                    elements.uploadFilename.style.display = 'block';
                    elements.uploadZone.querySelector('.upload-icon').textContent = 'âœ…';
                    elements.uploadZone.querySelector('.upload-text').textContent = 'ë¶„ì„í‘œ ì—…ë¡œë“œ ì™„ë£Œ!';

                    elements.yearSelect.value = data.year;
                    elements.quarterSelect.value = data.quarter;
                    
                    const periodValue = document.getElementById('periodValue');
                    periodValue.textContent = `${data.year}ë…„ ${data.quarter}ë¶„ê¸°`;
                    periodValue.classList.remove('waiting');
                    
                    // ë³€í™˜ ì •ë³´ í‘œì‹œ
                    const conversionInfo = document.getElementById('conversionInfo');
                    
                    // ë³€í™˜ ì •ë³´ ìˆ¨ê¹€ (ë¶„ì„í‘œë§Œ ì—…ë¡œë“œ)
                    if (conversionInfo) {
                        conversionInfo.style.display = 'none';
                    }
                    
                    // UI ìƒíƒœ ì—…ë°ì´íŠ¸ (ë¶„ì„í‘œ ëª¨ë“œ)
                    updateUIForFileType('analysis');
                    
                    // ë³´ë„ìë£Œ ìƒì„± ì¤€ë¹„ ì™„ë£Œ íŒíŠ¸ í‘œì‹œ
                    const reportGenerationHint = document.getElementById('reportGenerationHint');
                    if (reportGenerationHint) {
                        reportGenerationHint.style.display = 'block';
                    }
                    
                    document.getElementById('uploadModalIcon').textContent = 'âœ…';
                    document.getElementById('uploadModalTitle').textContent = 'ë¶„ì„í‘œ ì—…ë¡œë“œ ì™„ë£Œ!';
                    document.getElementById('uploadModalSubtitle').textContent = 'ë³´ë„ìë£Œë¥¼ ìƒì„±í•  ì¤€ë¹„ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤.';
                    
                    // Step 3ì€ ì´ë¯¸ ìˆ¨ê¹€ ì²˜ë¦¬ë¨
                    updateUploadStep(4, 'completed', 'ë³´ë„ìë£Œ ìƒì„± ì¤€ë¹„ ì™„ë£Œ');
                    
                    hideUploadModal(2000);
                    setTimeout(() => {
                        generateAllReports();
                    }, 2100);
                    
                    // ì‹œìŠ¤í…œ ì•Œë¦¼: ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ
                    sendSystemNotification('ğŸ“ íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ', `${data.filename || 'íŒŒì¼'}ì´ ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                } else {
                    // ì˜¤ë¥˜ ë°œìƒ
                    document.getElementById('uploadModalIcon').textContent = 'âŒ';
                    document.getElementById('uploadModalTitle').textContent = 'ì—…ë¡œë“œ ì‹¤íŒ¨';
                    document.getElementById('uploadModalSubtitle').textContent = data.error || 'íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                    hideUploadModal(3000);
                    showToast(data.error || 'ì—…ë¡œë“œ ì‹¤íŒ¨', 'error');
                }
            } catch (err) {
                console.error('ì—…ë¡œë“œ ì˜¤ë¥˜:', err);
                showToast('íŒŒì¼ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ===== í¸ì§‘ ëª¨ë“œ í•¨ìˆ˜ë“¤ =====
        function getCurrentReportInfo() {
            // í˜„ì¬ ì„ íƒëœ ë³´ë„ìë£Œ ì •ë³´ ë°˜í™˜
            if (state.currentSummaryIndex >= 0) {
                return { type: 'summary', report: state.summaryReports[state.currentSummaryIndex] };
            } else if (state.currentReportIndex >= 0) {
                return { type: 'sectoral', report: state.sectoralReports[state.currentReportIndex] };
            } else if (state.currentRegionalIndex >= 0) {
                return { type: 'regional', report: state.regionalReports[state.currentRegionalIndex] };
            } else if (state.currentStatisticsIndex >= 0) {
                return { type: 'statistics', report: state.statisticsReports[state.currentStatisticsIndex] };
            }
            return null;
        }

        function enterEditMode() {
            const reportInfo = getCurrentReportInfo();
            if (!reportInfo) {
                showToast('í¸ì§‘í•  ë³´ë„ìë£Œë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.', 'warning');
                return;
            }

            isEditMode = true;
            currentEditingReport = reportInfo;
            
            // ì›ë³¸ ì €ì¥
            originalHtmlBeforeEdit = state.cachedHtml[reportInfo.type][reportInfo.report.id];
            
            // iframe ë‚´ì—ì„œ ì§ì ‘ í¸ì§‘ ëª¨ë“œ í™œì„±í™” (ìŠ¤íƒ€ì¼ ìœ ì§€)
            const iframeDoc = elements.previewIframe.contentDocument || elements.previewIframe.contentWindow.document;
            
            // bodyë¥¼ í¸ì§‘ ê°€ëŠ¥í•˜ê²Œ ì„¤ì •
            iframeDoc.body.contentEditable = 'true';
            iframeDoc.body.style.cursor = 'text';
            
            // í¸ì§‘ ê°€ëŠ¥í•œ ìš”ì†Œì— í•˜ì´ë¼ì´íŠ¸ ìŠ¤íƒ€ì¼ ì¶”ê°€
            const editStyle = iframeDoc.createElement('style');
            editStyle.id = 'edit-mode-style';
            editStyle.textContent = `
                [contenteditable="true"]:focus {
                    outline: 2px solid #007bff;
                    outline-offset: 2px;
                }
                body {
                    cursor: text !important;
                }
                td, th, p, span, div, h1, h2, h3, h4, h5, h6, li {
                    min-height: 1em;
                }
            `;
            iframeDoc.head.appendChild(editStyle);
            
            // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
            elements.editBtn.style.display = 'none';
            elements.saveEditBtn.style.display = 'inline-flex';
            elements.cancelEditBtn.style.display = 'inline-flex';
            elements.markReviewedBtn.style.display = 'none';
            
            showToast('í¸ì§‘ ëª¨ë“œê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤. í…ìŠ¤íŠ¸ë¥¼ í´ë¦­í•˜ì—¬ ìˆ˜ì •í•˜ì„¸ìš”.', 'info');
        }

        function extractStyles(headHtml) {
            // headì—ì„œ style íƒœê·¸ ì¶”ì¶œ
            const styleMatch = headHtml.match(/<style[^>]*>([\s\S]*?)<\/style>/gi);
            if (styleMatch) {
                return styleMatch.map(s => s.replace(/<\/?style[^>]*>/gi, '')).join('\n');
            }
            return '';
        }

        function makeEditable(html) {
            // DOM íŒŒì‹±
            const parser = new DOMParser();
            const doc = parser.parseFromString(`<div>${html}</div>`, 'text/html');
            const container = doc.body.firstChild;
            
            // í…ìŠ¤íŠ¸ ë…¸ë“œë¥¼ í¬í•¨í•œ ëª¨ë“  ìš”ì†Œì— contenteditable ì¶”ê°€
            const editableSelectors = [
                'p', 'span', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
                'td', 'th', 'li', 'div.value', 'div.text', 'div.title',
                '.summary-text', '.description', '.content', '.data-value',
                '.region-name', '.change-value', '.percent'
            ];
            
            // ëª¨ë“  í…ìŠ¤íŠ¸ í¬í•¨ ìš”ì†Œ ì²˜ë¦¬
            container.querySelectorAll('*').forEach(el => {
                // ì´ë¯¸ì§€, SVG, í…Œì´ë¸” êµ¬ì¡° ë“±ì€ ì œì™¸
                const tagName = el.tagName.toLowerCase();
                if (['img', 'svg', 'path', 'table', 'tr', 'thead', 'tbody', 'script', 'style', 'br', 'hr'].includes(tagName)) {
                    return;
                }
                
                // ì§ì ‘ í…ìŠ¤íŠ¸ë¥¼ í¬í•¨í•˜ëŠ” ê²½ìš°ë§Œ í¸ì§‘ ê°€ëŠ¥
                const hasDirectText = Array.from(el.childNodes).some(node => 
                    node.nodeType === Node.TEXT_NODE && node.textContent.trim().length > 0
                );
                
                if (hasDirectText || editableSelectors.some(sel => el.matches(sel))) {
                    el.setAttribute('contenteditable', 'true');
                }
            });
            
            return container.innerHTML;
        }

        function saveEditedContent() {
            if (!currentEditingReport) {
                showToast('ì €ì¥í•  ë³´ë„ìë£Œê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            // iframeì—ì„œ ì§ì ‘ í¸ì§‘ëœ ë‚´ìš© ì¶”ì¶œ
            const iframeDoc = elements.previewIframe.contentDocument || elements.previewIframe.contentWindow.document;
            
            // í¸ì§‘ ëª¨ë“œ ìŠ¤íƒ€ì¼ ì œê±°
            const editStyle = iframeDoc.getElementById('edit-mode-style');
            if (editStyle) editStyle.remove();
            
            // contentEditable ë¹„í™œì„±í™”
            iframeDoc.body.contentEditable = 'false';
            iframeDoc.body.style.cursor = '';
            
            // í˜„ì¬ ìƒíƒœì˜ ì „ì²´ HTML ì €ì¥
            const newHtml = `<!DOCTYPE html>\n<html lang="ko">\n${iframeDoc.documentElement.innerHTML}\n</html>`;
            
            // ìºì‹œ ì—…ë°ì´íŠ¸
            const { type, report } = currentEditingReport;
            state.cachedHtml[type][report.id] = newHtml;
            
            // htmlCacheë„ ì—…ë°ì´íŠ¸ (ìµœì¢… ë¬¸ì„œ ìƒì„±ìš©)
            const cacheKey = `${type}_${report.id}`;
            state.htmlCache[cacheKey] = newHtml;
            
            // í¸ì§‘ ëª¨ë“œ ì¢…ë£Œ
            exitEditMode();
            
            // ìˆ˜ì •ë¨ í‘œì‹œ
            markReportAsEdited(type, report.id);
            
            showToast('âœ… ë³€ê²½ì‚¬í•­ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }

        function cancelEditMode() {
            // iframeì—ì„œ í¸ì§‘ ëª¨ë“œ í•´ì œ
            const iframeDoc = elements.previewIframe.contentDocument || elements.previewIframe.contentWindow.document;
            
            // í¸ì§‘ ëª¨ë“œ ìŠ¤íƒ€ì¼ ì œê±°
            const editStyle = iframeDoc.getElementById('edit-mode-style');
            if (editStyle) editStyle.remove();
            
            // contentEditable ë¹„í™œì„±í™”
            iframeDoc.body.contentEditable = 'false';
            iframeDoc.body.style.cursor = '';
            
            // ì›ë³¸ HTMLë¡œ ë³µì›
            if (originalHtmlBeforeEdit) {
                elements.previewIframe.srcdoc = originalHtmlBeforeEdit;
            }
            
            exitEditMode();
            showToast('í¸ì§‘ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
        }

        function exitEditMode() {
            isEditMode = false;
            originalHtmlBeforeEdit = null;
            currentEditingReport = null;
            
            // ë²„íŠ¼ ìƒíƒœ ë³µì›
            elements.editBtn.style.display = 'inline-flex';
            elements.saveEditBtn.style.display = 'none';
            elements.cancelEditBtn.style.display = 'none';
            elements.markReviewedBtn.style.display = 'block';
        }

        function markReportAsEdited(type, reportId) {
            // í¸ì§‘ëœ ë³´ë„ìë£Œ í‘œì‹œ (ì˜µì…˜: ë¦¬ìŠ¤íŠ¸ì— í‘œì‹œ ì¶”ê°€)
            if (!state.editedReports) {
                state.editedReports = { summary: new Set(), sectoral: new Set(), regional: new Set(), statistics: new Set() };
            }
            state.editedReports[type].add(reportId);
            
            // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            renderSummaryReportList();
            renderReportList();
            renderRegionalReportList();
            renderStatisticsReportList();
        }

        // ===== í˜„ì¬ ë¯¸ë¦¬ë³´ê¸° iframe ë‚´ìš©ì„ ìºì‹œì— ë™ê¸°í™” =====
        function syncCurrentPreviewToCache() {
            try {
                if (state.currentGlobalIndex < 0 || state.currentGlobalIndex >= state.allReports.length) {
                    console.log('[ìºì‹œ ë™ê¸°í™”] í˜„ì¬ ë³´ê³  ìˆëŠ” ë³´ë„ìë£Œê°€ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                const report = state.allReports[state.currentGlobalIndex];
                if (!report) {
                    console.warn('[ìºì‹œ ë™ê¸°í™”] ë³´ê³  ìˆëŠ” ë³´ë„ìë£Œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                const iframe = elements.previewIframe;
                if (!iframe) {
                    console.warn('[ìºì‹œ ë™ê¸°í™”] previewIframeì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                // iframe ì ‘ê·¼ ì‹œë„ (í¬ë¡œìŠ¤ ì˜¤ë¦¬ì§„ ë¬¸ì œ ë°©ì§€)
                let iframeDoc = null;
                try {
                    iframeDoc = iframe.contentDocument || iframe.contentWindow?.document;
                } catch (e) {
                    console.warn('[ìºì‹œ ë™ê¸°í™”] iframe ì ‘ê·¼ ì‹¤íŒ¨ (í¬ë¡œìŠ¤ ì˜¤ë¦¬ì§„):', e);
                    // srcdocë¡œ ì„¤ì •ëœ ê²½ìš° ì§ì ‘ ì ‘ê·¼ ê°€ëŠ¥
                    if (iframe.srcdoc) {
                        // srcdocì—ì„œ ì§ì ‘ ì¶”ì¶œ
                        const cacheKey = `${report.type}_${report.id}`;
                        if (state.cachedHtml[report.type] && state.cachedHtml[report.type][report.id]) {
                            state.htmlCache[cacheKey] = state.cachedHtml[report.type][report.id];
                            console.log(`[ìºì‹œ ë™ê¸°í™”] srcdocì—ì„œ ìºì‹œ ë³µì‚¬: ${cacheKey}`);
                        }
                    }
                    return;
                }
                
                if (iframeDoc && iframeDoc.documentElement) {
                    // í˜„ì¬ iframeì˜ HTML ë‚´ìš©ì„ ìºì‹œì— ì €ì¥
                    const currentHtml = iframeDoc.documentElement.outerHTML;
                    const cacheKey = `${report.type}_${report.id}`;
                    state.htmlCache[cacheKey] = currentHtml;
                    if (!state.cachedHtml[report.type]) {
                        state.cachedHtml[report.type] = {};
                    }
                    state.cachedHtml[report.type][report.id] = currentHtml;
                    console.log(`[ìºì‹œ ë™ê¸°í™”] ì„±ê³µ: ${cacheKey} (${currentHtml.length} bytes)`);
                } else {
                    console.warn('[ìºì‹œ ë™ê¸°í™”] iframe ë¬¸ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    // í´ë°±: ê¸°ì¡´ ìºì‹œ ì‚¬ìš©
                    const cacheKey = `${report.type}_${report.id}`;
                    if (state.cachedHtml[report.type] && state.cachedHtml[report.type][report.id]) {
                        state.htmlCache[cacheKey] = state.cachedHtml[report.type][report.id];
                        console.log(`[ìºì‹œ ë™ê¸°í™”] í´ë°±: ê¸°ì¡´ ìºì‹œ ì‚¬ìš© ${cacheKey}`);
                    }
                }
            } catch (e) {
                console.warn('[ìºì‹œ ë™ê¸°í™”] ì˜ˆì™¸ ë°œìƒ:', e);
                // í´ë°±: ëª¨ë“  ìƒì„±ëœ ë³´ë„ìë£Œì˜ ìºì‹œë¥¼ htmlCacheì— ë³µì‚¬
                for (const type of ['summary', 'sectoral', 'regional', 'statistics']) {
                    if (state.cachedHtml[type]) {
                        for (const [id, html] of Object.entries(state.cachedHtml[type])) {
                            const cacheKey = `${type}_${id}`;
                            if (!state.htmlCache[cacheKey]) {
                                state.htmlCache[cacheKey] = html;
                            }
                        }
                    }
                }
                console.log('[ìºì‹œ ë™ê¸°í™”] í´ë°±: ëª¨ë“  ìºì‹œë¥¼ htmlCacheì— ë³µì‚¬ ì™„ë£Œ');
            }
        }
        
        // ===== íŒŒì¼ ì €ì¥ (ì €ì¥ ìœ„ì¹˜ ì„ íƒ ì§€ì›) =====
        async function saveFileWithPicker(blob, filename) {
            // File System Access API ì§€ì› í™•ì¸
            if ('showSaveFilePicker' in window) {
                try {
                    const handle = await window.showSaveFilePicker({
                        suggestedName: filename,
                        types: [{
                            description: 'HTML íŒŒì¼',
                            accept: { 'text/html': ['.html'] }
                        }]
                    });
                    
                    const writable = await handle.createWritable();
                    await writable.write(blob);
                    await writable.close();
                    return true;
                } catch (err) {
                    if (err.name === 'AbortError') {
                        // ì‚¬ìš©ìê°€ ì·¨ì†Œí•¨
                        return false;
                    }
                    console.warn('File System Access API ì˜¤ë¥˜, ê¸°ë³¸ ë‹¤ìš´ë¡œë“œë¡œ ì „í™˜:', err);
                }
            }
            
            // í´ë°±: ê¸°ë³¸ ë‹¤ìš´ë¡œë“œ (ë¸Œë¼ìš°ì € ì„¤ì •ì— ë”°ë¼ ì €ì¥ ìœ„ì¹˜ ë¬»ê¸°)
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            return true;
        }
        
        // ===== JavaScriptë¡œ ìƒì„±ëœ ì°¨íŠ¸/ê·¸ë˜í”„ ìš”ì†Œ ì œê±° =====
        function removeJavaScriptElements(html) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // 1. Canvas ìš”ì†Œ ì œê±°
            doc.querySelectorAll('canvas').forEach(canvas => {
                console.log('[ë‚´ë³´ë‚´ê¸°] Canvas ìš”ì†Œ ì œê±°:', canvas.className || canvas.id || 'unnamed');
                canvas.remove();
            });
            
            // 2. Chart.js ê´€ë ¨ ìŠ¤í¬ë¦½íŠ¸ íƒœê·¸ ì œê±°
            doc.querySelectorAll('script').forEach(script => {
                const src = script.getAttribute('src') || '';
                const content = script.textContent || '';
                if (src.includes('chart') || src.includes('Chart.js') || 
                    content.includes('Chart') || content.includes('chart.js') ||
                    content.includes('new Chart') || content.includes('Chart.register')) {
                    console.log('[ë‚´ë³´ë‚´ê¸°] Chart.js ìŠ¤í¬ë¦½íŠ¸ ì œê±°:', src || 'inline script');
                    script.remove();
                }
            });
            
            // 3. ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ ì œê±° (canvasë¥¼ í¬í•¨í•˜ëŠ” ì»¨í…Œì´ë„ˆ)
            doc.querySelectorAll('.chart-container, .chart-wrapper, .chart-area, [class*="chart"], [id*="chart"]').forEach(container => {
                // Canvasê°€ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ ì œê±°
                if (container.querySelector('canvas')) {
                    console.log('[ë‚´ë³´ë‚´ê¸°] ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ ì œê±°:', container.className || container.id || 'unnamed');
                    container.remove();
                }
            });
            
            // 4. Chart.js ê´€ë ¨ ìŠ¤íƒ€ì¼ íƒœê·¸ ì œê±°
            doc.querySelectorAll('style').forEach(style => {
                const content = style.textContent || '';
                if (content.includes('chart') || content.includes('canvas')) {
                    // ì°¨íŠ¸ ê´€ë ¨ ìŠ¤íƒ€ì¼ë§Œ ì œê±°í•˜ê±°ë‚˜ ì „ì²´ ìŠ¤íƒ€ì¼ íƒœê·¸ ì œê±°
                    // ì—¬ê¸°ì„œëŠ” ì°¨íŠ¸ ê´€ë ¨ ìŠ¤íƒ€ì¼ì´ í¬í•¨ëœ ê²½ìš°ë§Œ ì œê±°
                    if (content.match(/\.chart|canvas\s*\{/i)) {
                        console.log('[ë‚´ë³´ë‚´ê¸°] ì°¨íŠ¸ ê´€ë ¨ ìŠ¤íƒ€ì¼ ì œê±°');
                        style.remove();
                    }
                }
            });
            
            // 5. JavaScript ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì†ì„± ì œê±° (onclick, onload ë“±)
            doc.querySelectorAll('*').forEach(element => {
                Array.from(element.attributes).forEach(attr => {
                    if (attr.name.startsWith('on') || attr.name.startsWith('data-chart')) {
                        element.removeAttribute(attr.name);
                    }
                });
            });
            
            // 6. A4 í¬ê¸°ì— ë§ê²Œ í‘œ ìµœì í™”
            doc.querySelectorAll('table').forEach(table => {
                table.style.width = '100%';
                table.style.tableLayout = 'fixed';
                table.style.fontSize = '9pt';
                table.style.borderCollapse = 'collapse';
            });
            
            // 7. ì´ë¯¸ì§€ ìµœì í™”
            doc.querySelectorAll('img').forEach(img => {
                img.style.maxWidth = '100%';
                img.style.height = 'auto';
                img.style.objectFit = 'contain';
            });
            
            return doc.documentElement.outerHTML;
        }
        
        // ===== í•œê¸€ ë¶ˆëŸ¬ì˜¤ê¸°ìš© HTML ë‚´ë³´ë‚´ê¸° =====
        async function exportHwpReadyDocument() {
            console.log('[ë‚´ë³´ë‚´ê¸°] ===== í•¨ìˆ˜ ì‹œì‘ =====');
            console.log('[ë‚´ë³´ë‚´ê¸°] ë²„íŠ¼ í´ë¦­ ê°ì§€');
            
            // ë²„íŠ¼ ë¹„í™œì„±í™” (ì¤‘ë³µ í´ë¦­ ë°©ì§€)
            if (elements.exportHwpReadyBtn) {
                console.log('[ë‚´ë³´ë‚´ê¸°] ë²„íŠ¼ ìš”ì†Œ í™•ì¸ë¨, ë¹„í™œì„±í™” ì¤‘');
                elements.exportHwpReadyBtn.disabled = true;
                elements.exportHwpReadyBtn.style.opacity = '0.6';
                elements.exportHwpReadyBtn.style.cursor = 'not-allowed';
            } else {
                console.error('[ë‚´ë³´ë‚´ê¸°] âŒ exportHwpReadyBtn ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
            }
            
            // allGenerated ì²´í¬ë¥¼ ë” ìœ ì—°í•˜ê²Œ (ìƒì„±ëœ ë³´ë„ìë£Œê°€ ìˆìœ¼ë©´ ì§„í–‰)
            console.log('[ë‚´ë³´ë‚´ê¸°] ìƒíƒœ í™•ì¸ ì¤‘...');
            console.log('[ë‚´ë³´ë‚´ê¸°] - state.allGenerated:', state.allGenerated);
            console.log('[ë‚´ë³´ë‚´ê¸°] - state.generatedReports:', state.generatedReports);
            
            const hasGeneratedReports = Object.keys(state.generatedReports).some(
                type => state.generatedReports[type] && state.generatedReports[type].size > 0
            );
            console.log('[ë‚´ë³´ë‚´ê¸°] - hasGeneratedReports:', hasGeneratedReports);
            
            if (!state.allGenerated && !hasGeneratedReports) {
                console.warn('[ë‚´ë³´ë‚´ê¸°] âš ï¸ ë³´ë„ìë£Œê°€ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                console.warn('[ë‚´ë³´ë‚´ê¸°] - allGenerated:', state.allGenerated);
                console.warn('[ë‚´ë³´ë‚´ê¸°] - hasGeneratedReports:', hasGeneratedReports);
                showToast('ë¨¼ì € ëª¨ë“  ë³´ë„ìë£Œë¥¼ ìƒì„±í•˜ì„¸ìš”.', 'warning');
                if (elements.exportHwpReadyBtn) {
                    elements.exportHwpReadyBtn.disabled = false;
                    elements.exportHwpReadyBtn.style.opacity = '1';
                    elements.exportHwpReadyBtn.style.cursor = 'pointer';
                }
                return;
            }
            
            console.log('[ë‚´ë³´ë‚´ê¸°] âœ… ë³´ë„ìë£Œ ìƒì„± ìƒíƒœ í™•ì¸ ì™„ë£Œ');
            
            // í˜„ì¬ ë¯¸ë¦¬ë³´ê¸° ë‚´ìš©ì„ ìºì‹œì— ë™ê¸°í™”
            console.log('[ë‚´ë³´ë‚´ê¸°] ìºì‹œ ë™ê¸°í™” ì‹œì‘...');
            try {
                syncCurrentPreviewToCache();
                console.log('[ë‚´ë³´ë‚´ê¸°] âœ… ìºì‹œ ë™ê¸°í™” ì™„ë£Œ');
            } catch (e) {
                console.warn('[ë‚´ë³´ë‚´ê¸°] âš ï¸ ìºì‹œ ë™ê¸°í™” ì‹¤íŒ¨ (ê³„ì† ì§„í–‰):', e);
            }
            
            // ë¡œë”© í‘œì‹œ
            console.log('[ë‚´ë³´ë‚´ê¸°] ë¡œë”© UI ìš”ì†Œ í™•ì¸ ì¤‘...');
            
            if (!elements.loadingOverlay || !elements.loadingTitle || !elements.loadingProgressFill || !elements.loadingProgressPercent || !elements.loadingCurrentText) {
                console.error('[ë‚´ë³´ë‚´ê¸°] âŒ ë¡œë”© UI ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                console.error('[ë‚´ë³´ë‚´ê¸°] - loadingOverlay:', elements.loadingOverlay);
                console.error('[ë‚´ë³´ë‚´ê¸°] - loadingTitle:', elements.loadingTitle);
                console.error('[ë‚´ë³´ë‚´ê¸°] - loadingProgressFill:', elements.loadingProgressFill);
                console.error('[ë‚´ë³´ë‚´ê¸°] - loadingProgressPercent:', elements.loadingProgressPercent);
                console.error('[ë‚´ë³´ë‚´ê¸°] - loadingCurrentText:', elements.loadingCurrentText);
                showToast('ë¡œë”© UI ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                if (elements.exportHwpReadyBtn) {
                    elements.exportHwpReadyBtn.disabled = false;
                    elements.exportHwpReadyBtn.style.opacity = '1';
                    elements.exportHwpReadyBtn.style.cursor = 'pointer';
                }
                return;
            }
            
            console.log('[ë‚´ë³´ë‚´ê¸°] âœ… ë¡œë”© UI ìš”ì†Œ í™•ì¸ ì™„ë£Œ');
            
            elements.loadingOverlay.style.display = 'flex';
            elements.loadingTitle.textContent = 'ğŸ“„ í•œê¸€ ë¶ˆëŸ¬ì˜¤ê¸°ìš© HTML ë¬¸ì„œ ìƒì„± ì¤‘...';
            elements.loadingCurrentText.textContent = 'í˜ì´ì§€ ìˆ˜ì§‘ ì¤‘';
            elements.loadingProgressFill.style.width = '0%';
            elements.loadingProgressPercent.textContent = '0%';
            
            try {
                console.log('[ë‚´ë³´ë‚´ê¸°] ===== HTML ìˆ˜ì§‘ ì‹œì‘ =====');
                // ëª¨ë“  ìºì‹œëœ HTML ìˆ˜ì§‘ (ìˆœì„œëŒ€ë¡œ)
                const rawPages = [];
                
                // HTML ê°€ì ¸ì˜¤ê¸° í—¬í¼ í•¨ìˆ˜ (htmlCache ìš°ì„ , cachedHtml í´ë°±)
                const getHtmlContent = (type, id) => {
                    const cacheKey = `${type}_${id}`;
                    console.log(`[ë‚´ë³´ë‚´ê¸°] HTML ì¡°íšŒ: ${cacheKey}`);
                    // htmlCache ìš°ì„  í™•ì¸ (í¸ì§‘ëœ ë‚´ìš© í¬í•¨)
                    if (state.htmlCache[cacheKey]) {
                        console.log(`[ë‚´ë³´ë‚´ê¸°] âœ… htmlCacheì—ì„œ ë°œê²¬: ${cacheKey} (${state.htmlCache[cacheKey].length} bytes)`);
                        return state.htmlCache[cacheKey];
                    }
                    // cachedHtml í´ë°±
                    if (state.cachedHtml[type] && state.cachedHtml[type][id]) {
                        console.log(`[ë‚´ë³´ë‚´ê¸°] âœ… cachedHtmlì—ì„œ ë°œê²¬: ${cacheKey} (${state.cachedHtml[type][id].length} bytes)`);
                        return state.cachedHtml[type][id];
                    }
                    console.warn(`[ë‚´ë³´ë‚´ê¸°] âš ï¸ HTMLì„ ì°¾ì„ ìˆ˜ ì—†ìŒ: ${cacheKey}`);
                    return null;
                };
                
                console.log('[ë‚´ë³´ë‚´ê¸°] ìºì‹œ ìƒíƒœ í™•ì¸:');
                console.log('[ë‚´ë³´ë‚´ê¸°] - htmlCache í‚¤ ê°œìˆ˜:', Object.keys(state.htmlCache || {}).length);
                console.log('[ë‚´ë³´ë‚´ê¸°] - cachedHtml íƒ€ì…:', Object.keys(state.cachedHtml || {}));
                
                // 1. ìš”ì•½ ë³´ë„ìë£Œ
                console.log('[ë‚´ë³´ë‚´ê¸°] 1. ìš”ì•½ ë³´ë„ìë£Œ ìˆ˜ì§‘ ì¤‘...');
                console.log('[ë‚´ë³´ë‚´ê¸°] - summaryReports ê°œìˆ˜:', state.summaryReports?.length || 0);
                for (const report of state.summaryReports) {
                    const html = getHtmlContent('summary', report.id);
                    if (html) {
                        rawPages.push({
                            html: html,
                            title: report.name,
                            category: 'summary',
                            report_id: report.id
                        });
                        console.log(`[ë‚´ë³´ë‚´ê¸°] âœ… ìš”ì•½ ì¶”ê°€: ${report.name}`);
                    } else {
                        console.warn(`[ë‚´ë³´ë‚´ê¸°] âš ï¸ ìš”ì•½ HTML ì—†ìŒ: ${report.name} (id: ${report.id})`);
                    }
                }
                
                // 2. ë¶€ë¬¸ë³„ ë³´ë„ìë£Œ
                console.log('[ë‚´ë³´ë‚´ê¸°] 2. ë¶€ë¬¸ë³„ ë³´ë„ìë£Œ ìˆ˜ì§‘ ì¤‘...');
                console.log('[ë‚´ë³´ë‚´ê¸°] - sectoralReports ê°œìˆ˜:', state.sectoralReports?.length || 0);
                for (const report of state.sectoralReports) {
                    const html = getHtmlContent('sectoral', report.id);
                    if (html) {
                        rawPages.push({
                            html: html,
                            title: report.name,
                            category: 'sectoral',
                            report_id: report.id
                        });
                        console.log(`[ë‚´ë³´ë‚´ê¸°] âœ… ë¶€ë¬¸ë³„ ì¶”ê°€: ${report.name}`);
                    } else {
                        console.warn(`[ë‚´ë³´ë‚´ê¸°] âš ï¸ ë¶€ë¬¸ë³„ HTML ì—†ìŒ: ${report.name} (id: ${report.id})`);
                    }
                }
                
                // 3. ì‹œë„ë³„ ë³´ë„ìë£Œ
                console.log('[ë‚´ë³´ë‚´ê¸°] 3. ì‹œë„ë³„ ë³´ë„ìë£Œ ìˆ˜ì§‘ ì¤‘...');
                console.log('[ë‚´ë³´ë‚´ê¸°] - regionalReports ê°œìˆ˜:', state.regionalReports?.length || 0);
                for (const region of state.regionalReports) {
                    const html = getHtmlContent('regional', region.id);
                    if (html) {
                        rawPages.push({
                            html: html,
                            title: region.name,
                            category: 'regional'
                        });
                        console.log(`[ë‚´ë³´ë‚´ê¸°] âœ… ì‹œë„ë³„ ì¶”ê°€: ${region.name}`);
                    } else {
                        console.warn(`[ë‚´ë³´ë‚´ê¸°] âš ï¸ ì‹œë„ë³„ HTML ì—†ìŒ: ${region.name} (id: ${region.id})`);
                    }
                }
                
                // 4. í†µê³„í‘œ - ë¹„í™œì„±í™”ë¨
                // í†µê³„í‘œ ê¸°ëŠ¥ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆì–´ ìˆ˜ì§‘í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤
                console.log('[ë‚´ë³´ë‚´ê¸°] 4. í†µê³„í‘œ ê±´ë„ˆë›°ê¸° (ë¹„í™œì„±í™”ë¨)');
                
                console.log(`[ë‚´ë³´ë‚´ê¸°] ===== HTML ìˆ˜ì§‘ ì™„ë£Œ: ì´ ${rawPages.length}ê°œ í˜ì´ì§€ =====`);
                
                // í˜ì´ì§€ê°€ ë¹„ì–´ìˆëŠ” ê²½ìš° ì—ëŸ¬ ì²˜ë¦¬
                if (rawPages.length === 0) {
                    console.error('[ë‚´ë³´ë‚´ê¸°] âŒ ìˆ˜ì§‘ëœ í˜ì´ì§€ê°€ ì—†ìŠµë‹ˆë‹¤!');
                    console.error('[ë‚´ë³´ë‚´ê¸°] ë””ë²„ê·¸ ì •ë³´:');
                    console.error('[ë‚´ë³´ë‚´ê¸°] - htmlCache:', state.htmlCache);
                    console.error('[ë‚´ë³´ë‚´ê¸°] - cachedHtml:', state.cachedHtml);
                    console.error('[ë‚´ë³´ë‚´ê¸°] - summaryReports:', state.summaryReports);
                    console.error('[ë‚´ë³´ë‚´ê¸°] - sectoralReports:', state.sectoralReports);
                    console.error('[ë‚´ë³´ë‚´ê¸°] - regionalReports:', state.regionalReports);
                    console.error('[ë‚´ë³´ë‚´ê¸°] - statisticsReports:', state.statisticsReports);
                    elements.loadingOverlay.style.display = 'none';
                    showToast('ìƒì„±ëœ ë³´ë„ìë£Œê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë³´ë„ìë£Œë¥¼ ìƒì„±í•˜ì„¸ìš”.', 'error');
                    if (elements.exportHwpReadyBtn) {
                        elements.exportHwpReadyBtn.disabled = false;
                        elements.exportHwpReadyBtn.style.opacity = '1';
                        elements.exportHwpReadyBtn.style.cursor = 'pointer';
                    }
                    return;
                }
                
                elements.loadingCurrentText.textContent = `${rawPages.length}ê°œ í˜ì´ì§€ ìˆ˜ì§‘ ì™„ë£Œ, JavaScript ìš”ì†Œ ì œê±° ì¤‘...`;
                elements.loadingProgressFill.style.width = '20%';
                elements.loadingProgressPercent.textContent = '20%';
                
                console.log('[ë‚´ë³´ë‚´ê¸°] ===== JavaScript ìš”ì†Œ ì œê±° ì‹œì‘ =====');
                // JavaScriptë¡œ ìƒì„±ëœ ì°¨íŠ¸/ê·¸ë˜í”„ ì œê±° (ê° í˜ì´ì§€ ìˆœì°¨ ì²˜ë¦¬)
                const pages = [];
                for (let i = 0; i < rawPages.length; i++) {
                    const page = rawPages[i];
                    console.log(`[ë‚´ë³´ë‚´ê¸°] í˜ì´ì§€ ${i + 1}/${rawPages.length} ì²˜ë¦¬ ì¤‘: ${page.title}`);
                    const progress = 20 + Math.floor((i / rawPages.length) * 60);
                    elements.loadingProgressFill.style.width = `${progress}%`;
                    elements.loadingProgressPercent.textContent = `${progress}%`;
                    elements.loadingCurrentText.textContent = `JavaScript ìš”ì†Œ ì œê±° ì¤‘... (${i + 1}/${rawPages.length}) ${page.title}`;
                    
                    // JavaScriptë¡œ ìƒì„±ëœ ì°¨íŠ¸/ê·¸ë˜í”„ ìš”ì†Œ ì œê±°
                    let cleanedHtml = page.html;
                    const hasCanvas = page.html.includes('<canvas');
                    const hasChart = page.html.includes('chart') || page.html.includes('Chart');
                    console.log(`[ë‚´ë³´ë‚´ê¸°] - Canvas í¬í•¨ ì—¬ë¶€: ${hasCanvas}, Chart í¬í•¨ ì—¬ë¶€: ${hasChart}`);
                    
                    if (hasCanvas || hasChart) {
                        try {
                            console.log(`[ë‚´ë³´ë‚´ê¸°] - JavaScript ìš”ì†Œ ì œê±° ì‹œì‘...`);
                            cleanedHtml = removeJavaScriptElements(page.html);
                            console.log(`[ë‚´ë³´ë‚´ê¸°] âœ… JavaScript ìš”ì†Œ ì œê±° ì™„ë£Œ`);
                        } catch (e) {
                            console.warn(`[ë‚´ë³´ë‚´ê¸°] âš ï¸ í˜ì´ì§€ ${i + 1} ì²˜ë¦¬ ì‹¤íŒ¨:`, e);
                            // ì‹¤íŒ¨ ì‹œ ì›ë³¸ ì‚¬ìš©
                            cleanedHtml = page.html;
                        }
                    }
                    
                    pages.push({
                        html: cleanedHtml,
                        title: page.title,
                        category: page.category
                    });
                    console.log(`[ë‚´ë³´ë‚´ê¸°] âœ… í˜ì´ì§€ ${i + 1} ì²˜ë¦¬ ì™„ë£Œ`);
                }
                console.log(`[ë‚´ë³´ë‚´ê¸°] ===== JavaScript ìš”ì†Œ ì œê±° ì™„ë£Œ: ì´ ${pages.length}ê°œ í˜ì´ì§€ =====`);
                
                elements.loadingCurrentText.textContent = `${pages.length}ê°œ í˜ì´ì§€ ë³€í™˜ ì™„ë£Œ, í•œê¸€ ë¶ˆëŸ¬ì˜¤ê¸°ìš© HTML ìƒì„± ì¤‘...`;
                elements.loadingProgressFill.style.width = '85%';
                elements.loadingProgressPercent.textContent = '85%';
                
                // ì—°ë„/ë¶„ê¸° ê°€ì ¸ì˜¤ê¸°
                const year = parseInt(elements.yearSelect.value) || 2025;
                const quarter = parseInt(elements.quarterSelect.value) || 2;
                console.log(`[ë‚´ë³´ë‚´ê¸°] ì—°ë„/ë¶„ê¸°: ${year}ë…„ ${quarter}ë¶„ê¸°`);
                
                // API í˜¸ì¶œ (í•œê¸€ ë¶ˆëŸ¬ì˜¤ê¸°ìš© HTML ìƒì„±)
                console.log(`[ë‚´ë³´ë‚´ê¸°] ===== API í˜¸ì¶œ ì‹œì‘ =====`);
                console.log(`[ë‚´ë³´ë‚´ê¸°] - URL: /api/export-hwp-ready`);
                console.log(`[ë‚´ë³´ë‚´ê¸°] - Method: POST`);
                console.log(`[ë‚´ë³´ë‚´ê¸°] - í˜ì´ì§€ ê°œìˆ˜: ${pages.length}`);
                console.log(`[ë‚´ë³´ë‚´ê¸°] - ì—°ë„: ${year}, ë¶„ê¸°: ${quarter}`);
                
                const requestBody = {
                    pages: pages,
                    year: year,
                    quarter: quarter
                };
                console.log(`[ë‚´ë³´ë‚´ê¸°] - Request body í¬ê¸°: ${JSON.stringify(requestBody).length} bytes`);
                
                const response = await fetch('/api/export-hwp-ready', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                
                console.log(`[ë‚´ë³´ë‚´ê¸°] - Response status: ${response.status} ${response.statusText}`);
                console.log(`[ë‚´ë³´ë‚´ê¸°] - Response ok: ${response.ok}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`[ë‚´ë³´ë‚´ê¸°] âŒ API í˜¸ì¶œ ì‹¤íŒ¨:`);
                    console.error(`[ë‚´ë³´ë‚´ê¸°] - Status: ${response.status}`);
                    console.error(`[ë‚´ë³´ë‚´ê¸°] - StatusText: ${response.statusText}`);
                    console.error(`[ë‚´ë³´ë‚´ê¸°] - Error body:`, errorText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log(`[ë‚´ë³´ë‚´ê¸°] ===== API ì‘ë‹µ ìˆ˜ì‹  =====`);
                console.log(`[ë‚´ë³´ë‚´ê¸°] - success: ${result.success}`);
                console.log(`[ë‚´ë³´ë‚´ê¸°] - total_pages: ${result.total_pages}`);
                console.log(`[ë‚´ë³´ë‚´ê¸°] - filename: ${result.filename}`);
                if (result.error) {
                    console.error(`[ë‚´ë³´ë‚´ê¸°] - error: ${result.error}`);
                }
                console.log(`[ë‚´ë³´ë‚´ê¸°] - ì‘ë‹µ ì „ì²´:`, result);
                
                elements.loadingProgressFill.style.width = '100%';
                elements.loadingProgressPercent.textContent = '100%';
                
                if (result.success) {
                    console.log(`[ë‚´ë³´ë‚´ê¸°] âœ… API í˜¸ì¶œ ì„±ê³µ`);
                    elements.loadingCurrentText.textContent = 'ì €ì¥ ìœ„ì¹˜ ì„ íƒ ì¤‘...';
                    
                    // ë¡œë”© ì˜¤ë²„ë ˆì´ ìˆ¨ê¸°ê³  íŒŒì¼ ì €ì¥ ëŒ€í™”ìƒì í‘œì‹œ
                    elements.loadingOverlay.style.display = 'none';
                    
                    // íŒŒì¼ ì €ì¥ (ì‚¬ìš©ìê°€ ìœ„ì¹˜ ì„ íƒ)
                    console.log(`[ë‚´ë³´ë‚´ê¸°] ===== íŒŒì¼ ì €ì¥ ì‹œì‘ =====`);
                    console.log(`[ë‚´ë³´ë‚´ê¸°] - HTML í¬ê¸°: ${result.html?.length || 0} bytes`);
                    console.log(`[ë‚´ë³´ë‚´ê¸°] - íŒŒì¼ëª…: ${result.filename}`);
                    
                    const blob = new Blob([result.html], { type: 'text/html; charset=utf-8' });
                    console.log(`[ë‚´ë³´ë‚´ê¸°] - Blob ìƒì„± ì™„ë£Œ: ${blob.size} bytes`);
                    
                    console.log(`[ë‚´ë³´ë‚´ê¸°] - saveFileWithPicker í˜¸ì¶œ ì¤‘...`);
                    const saved = await saveFileWithPicker(blob, result.filename);
                    console.log(`[ë‚´ë³´ë‚´ê¸°] - saveFileWithPicker ê²°ê³¼: ${saved}`);
                    
                    if (saved) {
                        console.log(`[ë‚´ë³´ë‚´ê¸°] âœ… íŒŒì¼ ì €ì¥ ì™„ë£Œ`);
                        
                        // í´ë¦½ë³´ë“œì— ìë™ ë³µì‚¬
                        try {
                            console.log(`[ë‚´ë³´ë‚´ê¸°] í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹œë„ ì¤‘...`);
                            
                            // HTML ë‚´ìš©ì„ í´ë¦½ë³´ë“œì— ë³µì‚¬
                            const htmlContent = result.html;
                            
                            // ì„ì‹œ div ìƒì„±í•˜ì—¬ HTML ë‚´ìš© ì‚½ì…
                            const tempDiv = document.createElement('div');
                            tempDiv.style.position = 'fixed';
                            tempDiv.style.left = '-9999px';
                            tempDiv.style.top = '-9999px';
                            tempDiv.innerHTML = htmlContent;
                            document.body.appendChild(tempDiv);
                            
                            // ì „ì²´ ì„ íƒ
                            const range = document.createRange();
                            range.selectNodeContents(tempDiv);
                            const selection = window.getSelection();
                            selection.removeAllRanges();
                            selection.addRange(range);
                            
                            // í´ë¦½ë³´ë“œì— ë³µì‚¬
                            let copySuccess = false;
                            
                            // Clipboard API ì‹œë„ (HTML í˜•ì‹ ì§€ì›)
                            if (navigator.clipboard && navigator.clipboard.write) {
                                try {
                                    // HTMLê³¼ í…ìŠ¤íŠ¸ ëª¨ë‘ ë³µì‚¬
                                    const htmlBlob = new Blob([htmlContent], { type: 'text/html' });
                                    const textBlob = new Blob([htmlContent], { type: 'text/plain' });
                                    
                                    // ClipboardItemì´ ì§€ì›ë˜ëŠ” ê²½ìš°
                                    if (typeof ClipboardItem !== 'undefined') {
                                        const clipboardItem = new ClipboardItem({
                                            'text/html': htmlBlob,
                                            'text/plain': textBlob
                                        });
                                        await navigator.clipboard.write([clipboardItem]);
                                        copySuccess = true;
                                        console.log(`[ë‚´ë³´ë‚´ê¸°] âœ… í´ë¦½ë³´ë“œ ë³µì‚¬ ì™„ë£Œ (ClipboardItem)`);
                                    } else {
                                        // ClipboardItemì´ ì—†ëŠ” ê²½ìš° í…ìŠ¤íŠ¸ë¡œ ë³µì‚¬
                                        await navigator.clipboard.writeText(htmlContent);
                                        copySuccess = true;
                                        console.log(`[ë‚´ë³´ë‚´ê¸°] âœ… í´ë¦½ë³´ë“œ ë³µì‚¬ ì™„ë£Œ (writeText)`);
                                    }
                                } catch (e) {
                                    console.warn(`[ë‚´ë³´ë‚´ê¸°] Clipboard API ì‹¤íŒ¨, execCommand ì‹œë„:`, e);
                                }
                            }
                            
                            // Fallback: execCommand ì‚¬ìš©
                            if (!copySuccess) {
                                try {
                                    const success = document.execCommand('copy');
                                    if (success) {
                                        copySuccess = true;
                                        console.log(`[ë‚´ë³´ë‚´ê¸°] âœ… í´ë¦½ë³´ë“œ ë³µì‚¬ ì™„ë£Œ (execCommand)`);
                                    }
                                } catch (e) {
                                    console.warn(`[ë‚´ë³´ë‚´ê¸°] execCommand ì‹¤íŒ¨:`, e);
                                }
                            }
                            
                            // ì„ íƒ í•´ì œ ë° ì„ì‹œ ìš”ì†Œ ì œê±°
                            selection.removeAllRanges();
                            document.body.removeChild(tempDiv);
                            
                            if (copySuccess) {
                                showToast(
                                    `âœ… í•œê¸€ ë¶ˆëŸ¬ì˜¤ê¸°ìš© HTML ë¬¸ì„œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. (${result.total_pages}í˜ì´ì§€)\n\n` +
                                    `ğŸ“‹ í´ë¦½ë³´ë“œì— ìë™ìœ¼ë¡œ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\n\n` +
                                    `í•œê¸€ì—ì„œ ë¶™ì—¬ë„£ê¸°:\n` +
                                    `Ctrl+V (ë˜ëŠ” Cmd+V)ë¡œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.\n\n` +
                                    `ë˜ëŠ” íŒŒì¼ â†’ ë¶ˆëŸ¬ì˜¤ê¸° â†’ ì €ì¥í•œ HTML íŒŒì¼ ì„ íƒ`,
                                    'success',
                                    10000
                                );
                            } else {
                                showToast(
                                    `âœ… í•œê¸€ ë¶ˆëŸ¬ì˜¤ê¸°ìš© HTML ë¬¸ì„œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. (${result.total_pages}í˜ì´ì§€)\n\n` +
                                    `âš ï¸ í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨\n\n` +
                                    `í•œê¸€ì—ì„œ ì—´ê¸°:\n` +
                                    `íŒŒì¼ â†’ ë¶ˆëŸ¬ì˜¤ê¸° â†’ ì €ì¥í•œ HTML íŒŒì¼ ì„ íƒ`,
                                    'success',
                                    8000
                                );
                            }
                        } catch (err) {
                            console.warn(`[ë‚´ë³´ë‚´ê¸°] âš ï¸ í´ë¦½ë³´ë“œ ë³µì‚¬ ì¤‘ ì˜¤ë¥˜:`, err);
                            showToast(
                                `âœ… í•œê¸€ ë¶ˆëŸ¬ì˜¤ê¸°ìš© HTML ë¬¸ì„œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. (${result.total_pages}í˜ì´ì§€)\n\n` +
                                `âš ï¸ í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨\n\n` +
                                `í•œê¸€ì—ì„œ ì—´ê¸°:\n` +
                                `íŒŒì¼ â†’ ë¶ˆëŸ¬ì˜¤ê¸° â†’ ì €ì¥í•œ HTML íŒŒì¼ ì„ íƒ`,
                                'success',
                                8000
                            );
                        }
                        
                        // ì‘ì—… ì™„ë£Œ í›„ ì—…ë¡œë“œ í´ë” ì •ë¦¬
                        setTimeout(async () => {
                            try {
                                const cleanupResponse = await fetch('/api/cleanup-uploads', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' }
                                });
                                const cleanupResult = await cleanupResponse.json();
                                if (cleanupResult.success && cleanupResult.deleted_count > 0) {
                                    console.log(`[ë‚´ë³´ë‚´ê¸°] [ì •ë¦¬] ${cleanupResult.deleted_count}ê°œ íŒŒì¼ ì •ë¦¬ ì™„ë£Œ`);
                                }
                            } catch (e) {
                                console.warn('[ë‚´ë³´ë‚´ê¸°] ì—…ë¡œë“œ í´ë” ì •ë¦¬ ì‹¤íŒ¨:', e);
                            }
                        }, 1000);
                    } else {
                        console.warn(`[ë‚´ë³´ë‚´ê¸°] âš ï¸ íŒŒì¼ ì €ì¥ ì·¨ì†Œë¨`);
                        showToast('ì €ì¥ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
                    }
                } else {
                    console.error(`[ë‚´ë³´ë‚´ê¸°] âŒ API í˜¸ì¶œ ì‹¤íŒ¨`);
                    elements.loadingOverlay.style.display = 'none';
                    const errorMsg = result.error || 'ë¬¸ì„œ ìƒì„± ì‹¤íŒ¨';
                    console.error('[ë‚´ë³´ë‚´ê¸°] ë¬¸ì„œ ìƒì„± ì‹¤íŒ¨:', errorMsg);
                    console.error('[ë‚´ë³´ë‚´ê¸°] ì „ì²´ ì‘ë‹µ:', result);
                    showToast(`ë¬¸ì„œ ìƒì„± ì‹¤íŒ¨: ${errorMsg}`, 'error');
                }
            } catch (err) {
                console.error('[ë‚´ë³´ë‚´ê¸°] ===== ì˜ˆì™¸ ë°œìƒ =====');
                console.error('[ë‚´ë³´ë‚´ê¸°] ì˜¤ë¥˜ íƒ€ì…:', err.constructor.name);
                console.error('[ë‚´ë³´ë‚´ê¸°] ì˜¤ë¥˜ ë©”ì‹œì§€:', err.message);
                console.error('[ë‚´ë³´ë‚´ê¸°] ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤:', err.stack);
                console.error('[ë‚´ë³´ë‚´ê¸°] ì „ì²´ ì˜¤ë¥˜ ê°ì²´:', err);
                if (elements.loadingOverlay) {
                    elements.loadingOverlay.style.display = 'none';
                }
                showToast(`ë¬¸ì„œ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${err.message || err}`, 'error');
            } finally {
                console.log(`[ë‚´ë³´ë‚´ê¸°] ===== í•¨ìˆ˜ ì¢…ë£Œ =====`);
                // ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
                if (elements.exportHwpReadyBtn) {
                    elements.exportHwpReadyBtn.disabled = false;
                    elements.exportHwpReadyBtn.style.opacity = '1';
                    elements.exportHwpReadyBtn.style.cursor = 'pointer';
                    console.log(`[ë‚´ë³´ë‚´ê¸°] ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”`);
                }
            }
        }

        // UI ìƒíƒœ ì—…ë°ì´íŠ¸ (íŒŒì¼ íƒ€ì…ì— ë”°ë¼)
        function updateUIForFileType(fileType) {
            const reportListSection = document.querySelector('.report-list-section');
            const allReportsList = document.getElementById('allReportsList');
            const previewPlaceholder = document.getElementById('previewPlaceholder');
            const weightInfoHint = document.getElementById('weightInfoHint');
            const reportGenerationHint = document.getElementById('reportGenerationHint');
            
            // ê¸°ì´ˆìë£Œ ê´€ë ¨ ì½”ë“œ ì œê±° (ë¶„ì„í‘œë§Œ ì—…ë¡œë“œ)
            
            if (fileType === 'analysis') {
                // ===== ë¶„ì„í‘œ ì—…ë¡œë“œ â†’ ë³´ë„ìë£Œ ìƒì„± ëª¨ë“œ =====
                reportListSection.style.opacity = '1';
                
                // íŒíŠ¸ í‘œì‹œ ìƒíƒœ
                if (weightInfoHint) weightInfoHint.style.display = 'none';
                if (reportGenerationHint) reportGenerationHint.style.display = 'block';
            }
        }
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: 'âœ“',
                error: 'âœ•',
                warning: 'âš ',
                info: 'â„¹'
            };

            toast.innerHTML = `
                <span style="font-size: 1.2rem;">${icons[type] || icons.info}</span>
                <span>${message}</span>
            `;

            elements.toastContainer.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }
    </script>
</body>
</html>
